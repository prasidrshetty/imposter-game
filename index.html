<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>Impostor â€” Party Game</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet"/>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<style>
  :root {
    /* â”€â”€ Secret Society Palette â”€â”€ */
    --bg:        #050508;
    --bg2:       #080a12;
    --card:      rgba(255,255,255,0.04);
    --card-hover:rgba(255,255,255,0.07);
    --border:    rgba(168,85,247,0.18);
    --border2:   rgba(255,255,255,0.07);
    --purple:    #b56cff;
    --purple2:   #7c3aed;
    --blue:      #4f9eff;
    --green:     #34d888;
    --red:       #ff4d6d;
    --yellow:    #ffc940;
    --pink:      #f472b6;
    --text:      #f0eeff;
    --muted:     rgba(220,210,255,0.38);
    /* Glass */
    --glass-bg:  rgba(14,10,28,0.72);
    --glass-border: rgba(180,140,255,0.22);
    --glass-blur: blur(24px) saturate(160%);
  }

  * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  html { height:100%; overflow-x:hidden; }
  body { min-height:100%; overflow-x:hidden; overflow-y:auto; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Nunito', sans-serif;
    display: flex; align-items: flex-start; justify-content: center;
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
    -webkit-text-size-adjust: 100%;
  }

  /* Canvas BG */
  #bgCanvas { position:fixed; inset:0; z-index:0; pointer-events:none; width:100%; height:100%; }

  /* Screens */
  .screen {
    position:relative; z-index:1; width:100%; max-width:480px;
    padding:24px 20px 80px; min-height:100vh;
    display:flex; flex-direction:column; align-items:center; justify-content:center;
  }
  .screen.hidden { display:none !important; }

  /* â”€â”€ Typography â”€â”€ */
  .title-giant {
    font-family:'Bebas Neue', cursive;
    font-size: clamp(64px, 18vw, 100px);
    letter-spacing: 6px; line-height:1;
    background: linear-gradient(135deg, #e8d8ff 0%, #b56cff 40%, #4f9eff 100%);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    animation: neonBlink 2.5s ease-in-out infinite;
  }
  @keyframes neonBlink {
    0%   { filter: drop-shadow(0 0 8px rgba(181,108,255,0.9)) drop-shadow(0 0 20px rgba(181,108,255,0.5)) drop-shadow(0 0 50px rgba(79,158,255,0.3)); }
    45%  { filter: drop-shadow(0 0 2px rgba(181,108,255,0.2)) drop-shadow(0 0 4px rgba(181,108,255,0.1)); }
    50%  { filter: drop-shadow(0 0 0px rgba(0,0,0,0)); }
    55%  { filter: drop-shadow(0 0 2px rgba(181,108,255,0.2)) drop-shadow(0 0 4px rgba(181,108,255,0.1)); }
    60%  { filter: drop-shadow(0 0 8px rgba(181,108,255,0.9)) drop-shadow(0 0 20px rgba(181,108,255,0.5)); }
    62%  { filter: drop-shadow(0 0 2px rgba(181,108,255,0.2)); }
    64%  { filter: drop-shadow(0 0 8px rgba(181,108,255,0.9)) drop-shadow(0 0 24px rgba(79,158,255,0.5)); }
    100% { filter: drop-shadow(0 0 8px rgba(181,108,255,0.9)) drop-shadow(0 0 20px rgba(181,108,255,0.5)) drop-shadow(0 0 50px rgba(79,158,255,0.3)); }
  }
  .title-big {
    font-family:'Bebas Neue', cursive;
    font-size: clamp(36px,10vw,56px); letter-spacing:4px;
    background: linear-gradient(135deg, #e8d8ff, #b56cff);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 0 12px rgba(181,108,255,0.4));
  }
  .subtitle { font-size:14px; color:var(--muted); letter-spacing:1px; }

  /* â”€â”€ Glass Cards â”€â”€ */
  .card {
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: 24px;
    padding: 28px 24px;
    backdrop-filter: var(--glass-blur);
    -webkit-backdrop-filter: var(--glass-blur);
    width: 100%;
    box-shadow:
      0 8px 32px rgba(0,0,0,0.4),
      inset 0 1px 0 rgba(255,255,255,0.07),
      inset 0 -1px 0 rgba(0,0,0,0.3);
    position: relative; overflow: hidden;
  }
  /* Subtle corner glow on card */
  .card::after {
    content:''; position:absolute; top:-1px; left:-1px; right:-1px; bottom:-1px;
    border-radius:24px; pointer-events:none;
    background: linear-gradient(135deg, rgba(181,108,255,0.08) 0%, transparent 50%, rgba(79,158,255,0.05) 100%);
  }
  .card-label {
    font-size:11px; text-transform:uppercase; letter-spacing:2.5px;
    color:rgba(181,108,255,0.6); margin-bottom:10px;
    font-weight:800;
  }

  /* â”€â”€ Inputs â”€â”€ */
  input[type=text], input[type=number] {
    width:100%;
    background: rgba(10,6,20,0.6);
    border: 1px solid rgba(181,108,255,0.2);
    border-radius:14px; padding:14px 18px;
    color: var(--text); font-size:16px;
    font-family:'Nunito',sans-serif; font-weight:700;
    outline:none; transition: border 0.25s, box-shadow 0.25s;
    backdrop-filter: blur(8px);
  }
  input[type=text]:focus, input[type=number]:focus {
    border-color: var(--purple);
    box-shadow: 0 0 0 3px rgba(181,108,255,0.15), 0 0 20px rgba(181,108,255,0.1);
  }
  input[type=text]::placeholder { color:rgba(220,210,255,0.2); font-weight:400; }
  input[type=range] { width:100%; accent-color:var(--purple); height:4px; }
  input[type=number] { -moz-appearance:textfield; text-align:center; }
  input[type=number]::-webkit-inner-spin-button { -webkit-appearance:none; }

  /* â•â• BUTTONS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  @keyframes shimmerSlide {
    0%   { transform: translateX(-100%) skewX(-15deg); }
    100% { transform: translateX(250%)  skewX(-15deg); }
  }
  @keyframes glowPulse {
    0%,100% { box-shadow: var(--btn-shadow), 0 0 0 0 var(--btn-glow); }
    50%      { box-shadow: var(--btn-shadow), 0 0 0 8px transparent; }
  }
  @keyframes btnPress {
    0%   { transform: scale(1); }
    40%  { transform: scale(0.95); }
    100% { transform: scale(1); }
  }
  @keyframes rippleOut {
    0%   { transform: scale(0); opacity: 0.5; }
    100% { transform: scale(4); opacity: 0; }
  }

  .btn {
    width:100%; padding:16px; border-radius:16px; border:none;
    font-family:'Nunito',sans-serif; font-weight:800; font-size:16px;
    cursor:pointer; letter-spacing:0.5px;
    position:relative; overflow:hidden;
    min-height:52px; -webkit-appearance:none;
    transition: transform 0.15s ease, box-shadow 0.2s ease, filter 0.2s ease;
    animation: glowPulse 3s ease-in-out infinite;
    /* shimmer pseudo-element */
  }
  /* Shimmer sweep on hover */
  .btn::before {
    content:'';
    position:absolute; inset:0;
    background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.25) 50%, transparent 100%);
    transform: translateX(-100%) skewX(-15deg);
    transition: none;
    pointer-events:none;
  }
  .btn:hover::before {
    animation: shimmerSlide 0.55s ease forwards;
  }
  /* Ripple on tap */
  .btn .ripple {
    position:absolute; border-radius:50%;
    width:60px; height:60px; margin-top:-30px; margin-left:-30px;
    background:rgba(255,255,255,0.35);
    animation:rippleOut 0.55s ease-out forwards;
    pointer-events:none;
  }
  .btn:active  { animation:btnPress 0.2s ease forwards; filter:brightness(1.15); }
  .btn:disabled { opacity:0.4; cursor:not-allowed; animation:none; }

  /* Primary â€” purple */
  .btn-primary {
    --btn-shadow: 0 8px 28px rgba(168,85,247,0.45);
    --btn-glow:   rgba(168,85,247,0.45);
    background: linear-gradient(135deg, #c084fc, #a855f7 45%, #7c3aed);
    color:#fff; box-shadow: var(--btn-shadow);
  }
  .btn-primary:hover { filter:brightness(1.1); }

  /* Secondary */
  .btn-secondary {
    --btn-shadow: 0 4px 16px rgba(0,0,0,0.3);
    --btn-glow:   rgba(255,255,255,0.08);
    background: rgba(255,255,255,0.07); color:#fff;
    border:1px solid rgba(255,255,255,0.14);
    box-shadow: var(--btn-shadow);
  }
  .btn-secondary:hover { background:rgba(255,255,255,0.12); border-color:rgba(255,255,255,0.25); }

  /* Green */
  .btn-green {
    --btn-shadow: 0 8px 28px rgba(34,197,94,0.45);
    --btn-glow:   rgba(34,197,94,0.45);
    background: linear-gradient(135deg, #4ade80, #22c55e 45%, #16a34a);
    color:#fff; box-shadow: var(--btn-shadow);
  }
  .btn-green:hover { filter:brightness(1.1); }

  /* Red */
  .btn-red {
    --btn-shadow: 0 8px 28px rgba(239,68,68,0.45);
    --btn-glow:   rgba(239,68,68,0.45);
    background: linear-gradient(135deg, #f87171, #ef4444 45%, #dc2626);
    color:#fff; box-shadow: var(--btn-shadow);
  }
  .btn-red:hover { filter:brightness(1.1); }

  /* Blue */
  .btn-blue {
    --btn-shadow: 0 8px 28px rgba(59,130,246,0.45);
    --btn-glow:   rgba(59,130,246,0.45);
    background: linear-gradient(135deg, #60a5fa, #3b82f6 45%, #2563eb);
    color:#fff; box-shadow: var(--btn-shadow);
  }
  .btn-blue:hover { filter:brightness(1.1); }

  /* Yellow */
  .btn-yellow {
    --btn-shadow: 0 8px 28px rgba(245,158,11,0.45);
    --btn-glow:   rgba(245,158,11,0.45);
    background: linear-gradient(135deg, #fbbf24, #f59e0b 45%, #d97706);
    color:#fff; box-shadow: var(--btn-shadow);
  }
  .btn-yellow:hover { filter:brightness(1.1); }

  .btn-sm   { padding:10px 20px; font-size:14px; border-radius:12px; width:auto; }
  .btn-icon { font-size:20px; margin-right:8px; }

  /* â”€â”€ Choice Cards â”€â”€ */
  .choice-grid { display:grid; grid-template-columns:1fr 1fr; gap:14px; width:100%; }
  .choice-card {
    background:rgba(14,10,28,0.7); border:1px solid var(--glass-border);
    border-radius:22px; padding:28px 16px; cursor:pointer;
    text-align:center; transition:all 0.28s cubic-bezier(0.4,0,0.2,1);
    display:flex; flex-direction:column; align-items:center; gap:10px;
    position:relative; overflow:hidden;
    backdrop-filter:var(--glass-blur); -webkit-backdrop-filter:var(--glass-blur);
    box-shadow:0 4px 24px rgba(0,0,0,0.35),inset 0 1px 0 rgba(255,255,255,0.06);
  }
  .choice-card::before {
    content:''; position:absolute; inset:0;
    background:linear-gradient(90deg,transparent,rgba(255,255,255,0.1),transparent);
    transform:translateX(-100%) skewX(-15deg); pointer-events:none;
  }
  .choice-card:hover::before { animation:shimmerSlide 0.5s ease forwards; }
  .choice-card:active { transform:scale(0.95); }
  .choice-card.purple:hover { background:rgba(181,108,255,0.12); border-color:rgba(181,108,255,0.5); box-shadow:0 0 0 1px rgba(181,108,255,0.3),0 16px 48px rgba(181,108,255,0.2); transform:translateY(-3px); }
  .choice-card.blue:hover   { background:rgba(79,158,255,0.12);  border-color:rgba(79,158,255,0.5);  box-shadow:0 0 0 1px rgba(79,158,255,0.3), 0 16px 48px rgba(79,158,255,0.2);  transform:translateY(-3px); }
  .choice-icon  { font-size:48px; transition:transform 0.3s ease; }
  .choice-card:hover .choice-icon { transform:scale(1.2) rotate(-5deg); }
  .choice-title { font-family:'Bebas Neue',cursive; font-size:22px; letter-spacing:2px; }
  .choice-card.purple .choice-title { color:var(--purple); }
  .choice-card.blue   .choice-title { color:var(--blue); }
  .choice-desc { font-size:12px; color:var(--muted); }

  /* â”€â”€ Code display â”€â”€ */
  .code-display {
    font-family:'Bebas Neue',cursive; font-size:clamp(48px,14vw,72px);
    letter-spacing:12px; color:var(--text);
    text-shadow:0 0 30px rgba(181,108,255,0.7),0 0 60px rgba(79,158,255,0.3);
    background:rgba(14,10,28,0.8); border:2px solid rgba(181,108,255,0.35);
    border-radius:20px; padding:20px 28px; text-align:center; width:100%;
    backdrop-filter:var(--glass-blur);
    box-shadow:0 0 40px rgba(181,108,255,0.12),inset 0 1px 0 rgba(255,255,255,0.06);
  }

  /* â”€â”€ Player list â”€â”€ */
  .player-item {
    display:flex; align-items:center; gap:12px;
    background:rgba(14,10,28,0.65); border:1px solid rgba(181,108,255,0.14);
    border-radius:16px; padding:12px 16px;
    animation:slideUp 0.3s ease; backdrop-filter:blur(12px);
    transition:border-color 0.2s, background 0.2s;
  }
  .player-item:hover { border-color:rgba(181,108,255,0.3); background:rgba(181,108,255,0.06); }
  .player-avatar {
    width:40px; height:40px; border-radius:50%;
    display:flex; align-items:center; justify-content:center;
    font-weight:900; font-size:16px; color:#fff; flex-shrink:0;
    box-shadow:0 0 12px rgba(181,108,255,0.25);
  }
  .player-name   { font-weight:700; font-size:15px; color:var(--text); }
  .player-badge  { font-size:12px; color:var(--yellow); letter-spacing:0.5px; }
  .player-status { margin-left:auto; font-size:18px; }

  /* â”€â”€ Word reveal â”€â”€ */
  .word-card {
    border-radius:28px; padding:40px 32px; text-align:center; width:100%;
    backdrop-filter:var(--glass-blur); position:relative; overflow:hidden;
  }
  .word-card::before {
    content:''; position:absolute; top:0; left:0; right:0; height:1px;
    background:linear-gradient(90deg,transparent,rgba(255,255,255,0.2),transparent);
  }
  .word-card.citizen {
    background:linear-gradient(135deg,rgba(52,216,136,0.1),rgba(20,80,50,0.15));
    border:1px solid rgba(52,216,136,0.35);
    box-shadow:0 0 60px rgba(52,216,136,0.12),inset 0 1px 0 rgba(52,216,136,0.1);
  }
  .word-card.impostor {
    background:linear-gradient(135deg,rgba(255,77,109,0.12),rgba(80,20,30,0.2));
    border:1px solid rgba(255,77,109,0.35);
    box-shadow:0 0 60px rgba(255,77,109,0.12),inset 0 1px 0 rgba(255,77,109,0.1);
  }
  .word-role { font-family:'Bebas Neue',cursive; font-size:clamp(42px,12vw,64px); letter-spacing:4px; }
  .word-role.citizen  { color:var(--green); text-shadow:0 0 20px rgba(52,216,136,0.6); }
  .word-role.impostor { color:var(--red);   text-shadow:0 0 20px rgba(255,77,109,0.6); }
  .secret-word {
    font-family:'Bebas Neue',cursive; font-size:clamp(52px,15vw,80px);
    letter-spacing:3px; color:#fff;
    text-shadow:0 0 30px rgba(52,216,136,0.7),0 0 60px rgba(52,216,136,0.3);
  }
  .word-hint { font-size:14px; color:var(--muted); margin-top:8px; }

  /* â”€â”€ Vote â”€â”€ */
  .vote-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; width:100%; }
  @media (max-width:360px) { .vote-grid{grid-template-columns:1fr;} .choice-grid{grid-template-columns:1fr;} }
  .vote-btn {
    background:rgba(14,10,28,0.65); border:1px solid rgba(181,108,255,0.15);
    border-radius:18px; padding:20px 12px; cursor:pointer;
    text-align:center; transition:all 0.22s; color:var(--text);
    font-family:'Nunito',sans-serif; min-height:110px; backdrop-filter:blur(12px);
  }
  .vote-btn:hover  { border-color:rgba(181,108,255,0.4); background:rgba(181,108,255,0.08); }
  .vote-btn:active { transform:scale(0.95); }
  .vote-btn.selected {
    background:rgba(255,201,64,0.12); border:2px solid var(--yellow);
    box-shadow:0 0 24px rgba(255,201,64,0.25),inset 0 1px 0 rgba(255,255,255,0.05);
  }
  .vote-btn.disabled { opacity:0.4; cursor:not-allowed; }
  .vote-btn-name { font-weight:800; font-size:15px; margin-top:8px; }
  .vote-count    { font-size:12px; color:var(--muted); margin-top:4px; }

  /* â”€â”€ Results â”€â”€ */
  .result-hero  { font-size:90px; text-align:center; animation:bounceIn 0.6s cubic-bezier(0.34,1.56,0.64,1); }
  .result-title { font-family:'Bebas Neue',cursive; font-size:clamp(44px,12vw,64px); letter-spacing:4px; text-align:center; }
  .result-win   { color:var(--yellow); text-shadow:0 0 40px rgba(255,201,64,0.6); }
  .result-lose  { color:var(--red);    text-shadow:0 0 40px rgba(255,77,109,0.6); }

  /* â”€â”€ Toast â”€â”€ */
  .toast {
    position:fixed; bottom:32px; left:50%; transform:translateX(-50%);
    padding:14px 28px; border-radius:40px; font-weight:700; font-size:14px;
    z-index:9999; white-space:nowrap; animation:slideUp 0.3s ease;
    pointer-events:none; backdrop-filter:blur(16px); border:1px solid rgba(255,255,255,0.1);
  }
  .toast.error   { background:linear-gradient(135deg,rgba(255,77,109,0.9),rgba(200,30,60,0.9));   box-shadow:0 8px 32px rgba(255,77,109,0.4); }
  .toast.success { background:linear-gradient(135deg,rgba(52,216,136,0.9),rgba(20,160,90,0.9));   box-shadow:0 8px 32px rgba(52,216,136,0.4); }
  .toast.info    { background:linear-gradient(135deg,rgba(79,158,255,0.9),rgba(40,100,200,0.9));   box-shadow:0 8px 32px rgba(79,158,255,0.4); }

  /* â”€â”€ Status dot â”€â”€ */
  .status-dot { width:8px; height:8px; border-radius:50%; display:inline-block; flex-shrink:0; }
  .status-dot.green { background:var(--green); box-shadow:0 0 8px rgba(52,216,136,0.8); animation:dotPulse 2s ease-in-out infinite; }
  @keyframes dotPulse { 0%,100%{box-shadow:0 0 8px rgba(52,216,136,0.8)} 50%{box-shadow:0 0 16px rgba(52,216,136,1)} }

  /* â”€â”€ Misc â”€â”€ */
  .divider { width:100%; height:1px; background:var(--glass-border); margin:8px 0; }
  .shimmer-reveal { animation:shimmer 0.6s ease; }
  .gap-8{gap:8px;} .gap-12{gap:12px;} .gap-16{gap:16px;} .gap-20{gap:20px;}
  .flex-col{display:flex;flex-direction:column;} .flex-row{display:flex;flex-direction:row;}
  .w-full{width:100%;} .text-center{text-align:center;} .hidden{display:none!important;}
  .mt-4{margin-top:4px;} .mt-8{margin-top:8px;} .mt-12{margin-top:12px;} .mt-16{margin-top:16px;} .mt-20{margin-top:20px;} .mt-24{margin-top:24px;}
  .mb-4{margin-bottom:4px;} .mb-8{margin-bottom:8px;} .mb-16{margin-bottom:16px;} .mb-24{margin-bottom:24px;}

  /* â”€â”€ Firebase setup â”€â”€ */
  .setup-box { background:rgba(79,158,255,0.06); border:1px solid rgba(79,158,255,0.25); border-radius:18px; padding:20px; backdrop-filter:blur(12px); }
  .setup-box textarea { width:100%; background:rgba(0,0,0,0.4); border:1px solid rgba(181,108,255,0.15); border-radius:10px; padding:12px; color:var(--text); font-family:monospace; font-size:12px; resize:vertical; min-height:120px; outline:none; }

  /* â”€â”€ Category chips â”€â”€ */
  .chip-grid { display:flex; flex-wrap:wrap; gap:8px; }
  .chip { padding:7px 16px; border-radius:20px; font-size:13px; font-weight:700; cursor:pointer; transition:all 0.2s; border:1px solid transparent; backdrop-filter:blur(8px); }
  .chip.off { background:rgba(255,255,255,0.04); color:var(--muted); border-color:rgba(255,255,255,0.08); }
  .chip.on  { background:rgba(181,108,255,0.18); color:var(--purple); border-color:rgba(181,108,255,0.5); box-shadow:0 0 12px rgba(181,108,255,0.2); }

  /* â”€â”€ Category info â”€â”€ */
  .category-info { display:flex; align-items:center; gap:12px; background:rgba(181,108,255,0.07); border:1px solid rgba(181,108,255,0.2); border-radius:14px; padding:14px 18px; backdrop-filter:blur(8px); }

  /* â”€â”€ Pulse ring â”€â”€ */
  .pulse-ring { width:100px; height:100px; border-radius:50%; border:2px solid var(--purple); box-shadow:0 0 20px rgba(181,108,255,0.4); animation:pulseRing 1.5s ease-in-out infinite; display:flex; align-items:center; justify-content:center; font-size:40px; margin:0 auto; }

  /* â”€â”€ Card flip â”€â”€ */
  .card-flip-scene { width:100%; perspective:1000px; }
  .card-flip-inner { position:relative; width:100%; transform-style:preserve-3d; transition:transform 0.7s cubic-bezier(0.4,0.2,0.2,1); }
  .card-flip-inner.flipped { transform:rotateY(180deg); }
  .card-flip-front, .card-flip-back { position:absolute; width:100%; backface-visibility:hidden; -webkit-backface-visibility:hidden; border-radius:24px; }
  .card-flip-front { position:relative; }
  .card-flip-back  { transform:rotateY(180deg); }

  /* â”€â”€ Countdown â”€â”€ */
  @keyframes countPop { 0%{transform:scale(0.3);opacity:0} 60%{transform:scale(1.3)} 100%{transform:scale(1);opacity:1} }
  .countdown-num { animation:countPop 0.4s cubic-bezier(0.34,1.56,0.64,1); font-family:'Bebas Neue',cursive; font-size:120px; line-height:1; }

  /* â”€â”€ Emoji reactions â”€â”€ */
  .reaction-bar { display:flex; gap:8px; justify-content:center; flex-wrap:wrap; width:100%; padding:12px 16px; background:rgba(14,10,28,0.65); border:1px solid rgba(181,108,255,0.15); border-radius:18px; backdrop-filter:blur(12px); }
  .reaction-btn { font-size:26px; background:none; border:none; cursor:pointer; padding:6px 10px; border-radius:12px; transition:all 0.15s; -webkit-tap-highlight-color:transparent; }
  .reaction-btn:active { transform:scale(1.4); }
  @keyframes floatUp { 0%{transform:translateY(0) scale(1);opacity:1} 100%{transform:translateY(-120px) scale(1.5);opacity:0} }
  .floating-reaction { position:fixed; font-size:36px; pointer-events:none; z-index:999; animation:floatUp 1.4s ease-out forwards; }

  /* â”€â”€ Accusation â”€â”€ */
  .accusation-feed { width:100%; max-height:140px; overflow-y:auto; display:flex; flex-direction:column; gap:6px; -webkit-overflow-scrolling:touch; }
  .accusation-msg { background:rgba(255,77,109,0.08); border:1px solid rgba(255,77,109,0.2); border-radius:12px; padding:8px 14px; font-size:13px; color:rgba(255,220,220,0.85); animation:slideUp 0.3s ease; }

  /* â”€â”€ Avatar picker â”€â”€ */
  .avatar-grid { display:grid; grid-template-columns:repeat(6,1fr); gap:8px; width:100%; }
  .avatar-opt { font-size:28px; background:rgba(14,10,28,0.6); border:2px solid transparent; border-radius:14px; padding:8px 4px; cursor:pointer; text-align:center; transition:all 0.15s; backdrop-filter:blur(8px); }
  .avatar-opt.selected { border-color:var(--purple); background:rgba(181,108,255,0.18); box-shadow:0 0 16px rgba(181,108,255,0.3); transform:scale(1.1); }
  .avatar-opt:active { transform:scale(0.9); }

  /* â”€â”€ Sound toggle â”€â”€ */
  .sound-toggle { position:fixed; top:16px; right:16px; z-index:100; background:rgba(14,10,28,0.8); border:1px solid rgba(181,108,255,0.25); border-radius:50%; width:40px; height:40px; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:18px; transition:all 0.2s; backdrop-filter:blur(12px); box-shadow:0 4px 16px rgba(0,0,0,0.4); }
  .sound-toggle:active { transform:scale(0.9); }

  /* â”€â”€ Leaderboard â”€â”€ */
  .lb-row { display:flex; align-items:center; gap:12px; padding:14px 16px; border-radius:16px; background:rgba(14,10,28,0.65); border:1px solid rgba(181,108,255,0.12); transition:all 0.4s ease; position:relative; overflow:hidden; backdrop-filter:blur(12px); }
  .lb-row.me     { background:rgba(181,108,255,0.1);  border-color:rgba(181,108,255,0.4); box-shadow:0 0 20px rgba(181,108,255,0.1); }
  .lb-row.first  { background:rgba(255,201,64,0.08);  border-color:rgba(255,201,64,0.4); }
  .lb-row.second { background:rgba(148,163,184,0.07); border-color:rgba(148,163,184,0.3); }
  .lb-row.third  { background:rgba(180,120,60,0.08);  border-color:rgba(180,120,60,0.3); }
  .lb-rank  { font-family:'Bebas Neue',cursive; font-size:26px; letter-spacing:1px; min-width:32px; text-align:center; }
  .lb-score { font-family:'Bebas Neue',cursive; font-size:28px; letter-spacing:1px; margin-left:auto; }
  @keyframes scorePop { 0%{transform:translateY(0);opacity:1} 100%{transform:translateY(-40px);opacity:0} }
  .score-delta { position:absolute; right:16px; top:4px; font-family:'Bebas Neue',cursive; font-size:22px; animation:scorePop 1.5s ease-out forwards; pointer-events:none; }

  /* â”€â”€ Scrollable â”€â”€ */
  .scrollable { overflow-y:auto; max-height:45vh; -webkit-overflow-scrolling:touch; }
  .scrollable::-webkit-scrollbar { width:3px; }
  .scrollable::-webkit-scrollbar-thumb { background:rgba(181,108,255,0.4); border-radius:3px; }

  @keyframes slideUp    { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:none} }
  @keyframes bounceIn   { from{transform:scale(0);opacity:0} 60%{transform:scale(1.2)} to{transform:scale(1);opacity:1} }
  @keyframes pulseRing  { 0%,100%{box-shadow:0 0 0 0 rgba(181,108,255,0.5)} 50%{box-shadow:0 0 0 20px rgba(181,108,255,0)} }
  @keyframes shimmer    { 0%{filter:brightness(3)} 100%{filter:brightness(1)} }
  @keyframes confettiFall { to{transform:translateY(110vh) rotate(720deg);opacity:0} }
  @keyframes spin       { to{transform:rotate(360deg)} }

  @supports (padding-bottom: env(safe-area-inset-bottom)) {
    .screen { padding-bottom: calc(80px + env(safe-area-inset-bottom)); }
    #screen-results > div:last-child { padding-bottom: calc(100px + env(safe-area-inset-bottom)); }
  }

  /* â”€â”€ Small phone fixes (iPhone SE, Galaxy A series) â”€â”€ */
  @media (max-width:380px) {
    .title-giant { font-size: 58px; }
    .title-big   { font-size: 32px; }
    .card        { padding: 20px 16px; }
    .btn         { padding: 14px; font-size: 15px; }
    .code-display { font-size: 44px; letter-spacing: 8px; }
    .word-role   { font-size: 36px; }
    .secret-word { font-size: 48px; }
    .choice-grid { grid-template-columns: 1fr; gap: 10px; }
    .vote-grid   { grid-template-columns: 1fr; }
    .result-hero { font-size: 72px; }
    #resultHeroTitle { font-size: 36px; }
  }

  /* â”€â”€ Landscape phone â”€â”€ */
  @media (max-height: 500px) and (orientation: landscape) {
    .screen { justify-content: flex-start; padding-top: 16px; }
    .title-giant { font-size: 48px; }
    .word-card   { padding: 20px; }
    #revealRoleEmoji { font-size: 48px; margin-bottom: 6px; }
    .secret-word { font-size: 42px; }
  }

  /* Firebase config modal */
  .modal-overlay {
    position:fixed; inset:0; background:rgba(0,0,0,0.85);
    backdrop-filter:blur(8px); z-index:100;
    display:flex; align-items:center; justify-content:center; padding:24px;
  }
  .modal-overlay.hidden { display:none !important; }
  .modal {
    background:#12131f; border:1px solid rgba(168,85,247,0.3);
    border-radius:28px; padding:32px 28px; width:100%; max-width:460px;
    max-height:90vh; overflow-y:auto;
  }

  /* Status dot */
  .status-dot {
    width:8px; height:8px; border-radius:50%; display:inline-block; margin-right:6px;
  }
  .status-dot.green { background:var(--green); box-shadow:0 0 8px var(--green); }
  .status-dot.red { background:var(--red); }
  .status-dot.yellow { background:var(--yellow); animation:pulseRing 1s infinite; }
</style>
</head>
<body>

<canvas id="bgCanvas"></canvas>
<div class="sound-toggle" id="soundToggle" onclick="toggleSound()" title="Toggle Sound">ğŸ”Š</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• FIREBASE SETUP MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay hidden" id="firebaseModal">
  <div class="modal">
    <div style="font-family:'Bebas Neue',cursive;font-size:32px;letter-spacing:3px;color:var(--blue);margin-bottom:8px;">FIREBASE SETUP</div>
    <p style="font-size:13px;color:var(--muted);margin-bottom:20px;line-height:1.6;">
      To play across multiple phones, paste your Firebase config below.<br>
      <a href="https://console.firebase.google.com" target="_blank" style="color:var(--blue);">Get free config at console.firebase.google.com â†’</a>
    </p>
    <div class="setup-box">
      <p class="card-label" style="margin-bottom:8px;">Paste your firebaseConfig object:</p>
      <textarea id="firebaseConfigInput" placeholder='const firebaseConfig = {
  apiKey: "AIza...",
  authDomain: "your-app.firebaseapp.com",
  databaseURL: "https://your-app-default-rtdb.firebaseio.com",
  projectId: "your-app",
  storageBucket: "your-app.appspot.com",
  messagingSenderId: "123456789",
  appId: "1:123..."
};'></textarea>
    </div>
    <div class="flex-col gap-12 mt-16">
      <button class="btn btn-blue" onclick="applyFirebaseConfig()">ğŸ”¥ Connect Firebase</button>
      <button class="btn btn-secondary" onclick="closeFirebaseModal()">Use Demo Mode (same device)</button>
    </div>
    <p style="font-size:11px;color:var(--muted);margin-top:12px;text-align:center;">Demo mode works on one device only. Firebase enables cross-phone play.</p>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCREEN: HOME â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screen-home">
  <div style="text-align:center;margin-bottom:8px;">
    <div style="font-size:12px;letter-spacing:5px;color:var(--purple);text-transform:uppercase;opacity:0.8;margin-bottom:12px;">ğŸ•µï¸ Party Game</div>
    <div class="title-giant">IMPOSTOR</div>
    <p class="subtitle mt-8">Find the spy before it's too late</p>
  </div>

  <!-- Firebase status -->
  <div style="display:flex;align-items:center;gap:8px;margin:20px 0 28px;font-size:13px;color:var(--muted);">
    <span class="status-dot" id="fbStatusDot" style="background:var(--yellow);"></span>
    <span id="fbStatusText">Not connected â€” <span style="color:var(--blue);cursor:pointer;text-decoration:underline;" onclick="openFirebaseModal()">Setup Firebase for multiplayer</span></span>
    <span id="fbResetBtn" style="display:none;margin-left:auto;font-size:11px;color:rgba(255,255,255,0.25);cursor:pointer;text-decoration:underline;" onclick="resetFirebase()">Reset</span>
  </div>

  <div class="choice-grid">
    <button class="choice-card purple" onclick="goTo('create')">
      <div class="choice-icon">ğŸ </div>
      <div class="choice-title">Create</div>
      <div class="choice-desc">Host a game room</div>
    </button>
    <button class="choice-card blue" onclick="goTo('join')">
      <div class="choice-icon">ğŸ”‘</div>
      <div class="choice-title">Join</div>
      <div class="choice-desc">Enter room code</div>
    </button>
  </div>

  <button onclick="goTo('rules')" style="margin-top:16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.12);border-radius:16px;padding:14px 32px;color:rgba(255,255,255,0.7);cursor:pointer;font-family:'Nunito',sans-serif;font-size:14px;font-weight:700;letter-spacing:0.5px;transition:all 0.2s;width:100%;"
    onmouseover="this.style.background='rgba(168,85,247,0.12)';this.style.borderColor='rgba(168,85,247,0.4)';this.style.color='#fff'"
    onmouseout="this.style.background='rgba(255,255,255,0.05)';this.style.borderColor='rgba(255,255,255,0.12)';this.style.color='rgba(255,255,255,0.7)'">
    ğŸ“– How to Play
  </button>

  <div style="display:flex;gap:32px;justify-content:center;margin-top:36px;">
    <div style="text-align:center">
      <div style="font-family:'Bebas Neue',cursive;font-size:28px;color:#fff;">8+</div>
      <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;">Categories</div>
    </div>
    <div style="text-align:center">
      <div style="font-family:'Bebas Neue',cursive;font-size:28px;color:#fff;">100+</div>
      <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;">Word Pairs</div>
    </div>
    <div style="text-align:center">
      <div style="font-family:'Bebas Neue',cursive;font-size:28px;color:#fff;">3â€“15</div>
      <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;">Players</div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCREEN: RULES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen hidden flex-col" id="screen-rules" style="justify-content:flex-start;padding-top:40px;gap:0;">
  <div style="width:100%;margin-bottom:24px;">
    <button onclick="goTo('home')" style="background:none;border:none;color:var(--muted);cursor:pointer;font-family:'Nunito',sans-serif;font-size:14px;padding:0;margin-bottom:16px;">â† Back</button>
    <div class="title-big" style="color:var(--purple);">HOW TO PLAY</div>
    <p class="subtitle mt-4">Master the art of deception ğŸ•µï¸</p>
  </div>

  <!-- What is Impostor -->
  <div style="width:100%;background:linear-gradient(135deg,rgba(168,85,247,0.15),rgba(59,130,246,0.1));border:1px solid rgba(168,85,247,0.3);border-radius:20px;padding:20px;margin-bottom:14px;">
    <div style="font-family:'Bebas Neue',cursive;font-size:22px;letter-spacing:2px;color:#fff;margin-bottom:10px;">ğŸ¯ THE GOAL</div>
    <p style="font-size:14px;color:rgba(255,255,255,0.75);line-height:1.7;">
      Everyone gets a <strong style="color:#fff;">secret word</strong> on their own phone.<br>
      Most players are <strong style="color:var(--green);">Citizens</strong> â€” they all get the <em>same word</em>.<br>
      One (or more) are <strong style="color:var(--red);">Impostors</strong> â€” they get a <em>similar but different word</em>.<br><br>
      Citizens must find the Impostor. The Impostor must blend in! ğŸ­
    </p>
  </div>

  <!-- Steps -->
  <div style="width:100%;display:flex;flex-direction:column;gap:10px;margin-bottom:14px;">

    <!-- Step 1 -->
    <div style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:18px;padding:18px;display:flex;gap:14px;align-items:flex-start;">
      <div style="width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,#a855f7,#7c3aed);display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',cursive;font-size:22px;flex-shrink:0;">1</div>
      <div>
        <div style="font-weight:800;font-size:15px;color:#fff;margin-bottom:4px;">Everyone Joins</div>
        <div style="font-size:13px;color:rgba(255,255,255,0.55);line-height:1.6;">Host creates a room and shares the <strong style="color:var(--purple);">6-letter code</strong>. All players join on their own phone using that code.</div>
      </div>
    </div>

    <!-- Step 2 -->
    <div style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:18px;padding:18px;display:flex;gap:14px;align-items:flex-start;">
      <div style="width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,#3b82f6,#2563eb);display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',cursive;font-size:22px;flex-shrink:0;">2</div>
      <div>
        <div style="font-weight:800;font-size:15px;color:#fff;margin-bottom:4px;">See Your Secret Word</div>
        <div style="font-size:13px;color:rgba(255,255,255,0.55);line-height:1.6;">Each phone privately shows your role. <strong style="color:var(--green);">Citizens</strong> see the word (e.g. <em>"Car"</em>). <strong style="color:var(--red);">Impostors</strong> see <strong>???</strong> â€” you don't know the word!</div>
      </div>
    </div>

    <!-- Step 3 -->
    <div style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:18px;padding:18px;display:flex;gap:14px;align-items:flex-start;">
      <div style="width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,#22c55e,#16a34a);display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',cursive;font-size:22px;flex-shrink:0;">3</div>
      <div>
        <div style="font-weight:800;font-size:15px;color:#fff;margin-bottom:4px;">Give Clues Out Loud</div>
        <div style="font-size:13px;color:rgba(255,255,255,0.55);line-height:1.6;">Everyone takes turns giving <strong style="color:#fff;">one clue</strong> about their word â€” face to face! Don't say the exact word. Impostor must fake a convincing clue without knowing it!</div>
      </div>
    </div>

    <!-- Step 4 -->
    <div style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:18px;padding:18px;display:flex;gap:14px;align-items:flex-start;">
      <div style="width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,#f59e0b,#d97706);display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',cursive;font-size:22px;flex-shrink:0;">4</div>
      <div>
        <div style="font-weight:800;font-size:15px;color:#fff;margin-bottom:4px;">Discuss & Debate</div>
        <div style="font-size:13px;color:rgba(255,255,255,0.55);line-height:1.6;">Talk it out! Who sounded suspicious? Who gave a weird clue? Debate among yourselves. When ready, <strong style="color:var(--yellow);">host taps Stop â†’ Vote</strong>.</div>
      </div>
    </div>

    <!-- Step 5 -->
    <div style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:18px;padding:18px;display:flex;gap:14px;align-items:flex-start;">
      <div style="width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,#ef4444,#dc2626);display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',cursive;font-size:22px;flex-shrink:0;">5</div>
      <div>
        <div style="font-weight:800;font-size:15px;color:#fff;margin-bottom:4px;">Vote on Your Phone</div>
        <div style="font-size:13px;color:rgba(255,255,255,0.55);line-height:1.6;">Everyone votes <strong style="color:#fff;">privately</strong> on their own phone. Most votes = eliminated. Results reveal who won â€” and who the Impostor really was! ğŸ‰</div>
      </div>
    </div>

  </div>

  <!-- Win conditions -->
  <div style="width:100%;display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;">
    <div style="background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3);border-radius:16px;padding:16px;text-align:center;">
      <div style="font-size:28px;margin-bottom:6px;">ğŸ‘¥</div>
      <div style="font-family:'Bebas Neue',cursive;font-size:16px;color:var(--green);letter-spacing:1px;margin-bottom:6px;">CITIZENS WIN</div>
      <div style="font-size:12px;color:rgba(255,255,255,0.5);line-height:1.5;">Vote out the Impostor correctly</div>
    </div>
    <div style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:16px;padding:16px;text-align:center;">
      <div style="font-size:28px;margin-bottom:6px;">ğŸ•µï¸</div>
      <div style="font-family:'Bebas Neue',cursive;font-size:16px;color:var(--red);letter-spacing:1px;margin-bottom:6px;">IMPOSTOR WINS</div>
      <div style="font-size:12px;color:rgba(255,255,255,0.5);line-height:1.5;">Avoid being voted out & survive</div>
    </div>
  </div>

  <!-- Tips -->
  <div style="width:100%;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:18px;padding:18px;margin-bottom:20px;">
    <div style="font-family:'Bebas Neue',cursive;font-size:18px;letter-spacing:2px;color:var(--yellow);margin-bottom:12px;">ğŸ’¡ PRO TIPS</div>
    <div style="display:flex;flex-direction:column;gap:8px;">
      <div style="font-size:13px;color:rgba(255,255,255,0.6);display:flex;gap:8px;"><span>ğŸŸ£</span><span>Impostors â€” listen carefully to others' clues before giving yours. Mirror their style!</span></div>
      <div style="font-size:13px;color:rgba(255,255,255,0.6);display:flex;gap:8px;"><span>ğŸŸ¢</span><span>Citizens â€” give clues specific enough to prove you know the word, but vague enough to not hand it to the Impostor.</span></div>
      <div style="font-size:13px;color:rgba(255,255,255,0.6);display:flex;gap:8px;"><span>ğŸ”´</span><span>Watch for hesitation! A long pause before giving a clue is very suspicious. ğŸ‘€</span></div>
      <div style="font-size:13px;color:rgba(255,255,255,0.6);display:flex;gap:8px;"><span>ğŸŸ¡</span><span>Best with 5â€“8 players for maximum chaos and fun!</span></div>
    </div>
  </div>

  <!-- Example round -->
  <div style="width:100%;background:rgba(59,130,246,0.08);border:1px solid rgba(59,130,246,0.2);border-radius:18px;padding:18px;margin-bottom:24px;">
    <div style="font-family:'Bebas Neue',cursive;font-size:18px;letter-spacing:2px;color:var(--blue);margin-bottom:12px;">ğŸ“ EXAMPLE ROUND</div>
    <div style="font-size:13px;color:rgba(255,255,255,0.6);line-height:1.8;">
      Word pair: <strong style="color:var(--green);">Car</strong> (citizens) vs <strong style="color:var(--red);">Bike</strong> (impostor)<br>
      Prasid: <em>"It has four wheels"</em> âœ…<br>
      Rahul: <em>"You need a licence for it"</em> âœ…<br>
      Sneha <span style="color:var(--red);">(impostor)</span>: <em>"People use it for daily travel"</em> ğŸ¤”<br>
      Arjun: <em>"It can go very fast on the highway"</em> âœ…<br><br>
      <span style="color:var(--yellow);">Everyone suspects Sneha â€” her clue works for both! Vote time... ğŸ—³ï¸</span>
    </div>
  </div>

  <button class="btn btn-primary w-full" onclick="goTo('home')" style="margin-bottom:8px;">
    ğŸ® Let's Play!
  </button>

</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCREEN: CREATE ROOM â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen hidden flex-col gap-16" id="screen-create" style="justify-content:flex-start;padding-top:48px;">
  <div>
    <button onclick="goTo('home')" style="background:none;border:none;color:var(--muted);cursor:pointer;font-family:'Nunito',sans-serif;font-size:14px;padding:0;margin-bottom:16px;">â† Back</button>
    <div class="title-big" style="color:var(--purple);">CREATE ROOM</div>
    <p class="subtitle mt-4">Set up the game for your crew</p>
  </div>

  <div class="card flex-col gap-16">
    <div>
      <div class="card-label">Your Name</div>
      <input type="text" id="createName" placeholder="Enter your name" maxlength="20" onkeydown="if(event.key==='Enter')createRoom()"/>
    </div>
    <div>
      <div class="card-label">Pick Your Avatar</div>
      <div class="avatar-grid" id="createAvatarGrid"></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
      <div>
        <div class="card-label">Impostors</div>
        <div style="display:flex;align-items:center;background:rgba(255,255,255,0.06);border:1px solid var(--border);border-radius:14px;overflow:hidden;">
          <button onclick="changeImpostors(-1)" style="background:none;border:none;color:#fff;font-size:22px;font-weight:900;width:44px;height:52px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.15s;" onmouseover="this.style.background='rgba(255,255,255,0.08)'" onmouseout="this.style.background='none'">âˆ’</button>
          <div style="flex:1;text-align:center;font-family:'Bebas Neue',cursive;font-size:32px;letter-spacing:2px;color:#fff;line-height:52px;" id="impostorCount">1</div>
          <button onclick="changeImpostors(1)" style="background:none;border:none;color:#fff;font-size:22px;font-weight:900;width:44px;height:52px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.15s;" onmouseover="this.style.background='rgba(255,255,255,0.08)'" onmouseout="this.style.background='none'">+</button>
        </div>
        <div style="font-size:11px;color:var(--muted);margin-top:6px;">Min 1</div>
      </div>
      <div>
        <div class="card-label">Max Players</div>
        <div style="display:flex;align-items:center;background:rgba(255,255,255,0.06);border:1px solid var(--border);border-radius:14px;overflow:hidden;">
          <button onclick="changeMaxPlayers(-1)" style="background:none;border:none;color:#fff;font-size:22px;font-weight:900;width:44px;height:52px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.15s;" onmouseover="this.style.background='rgba(255,255,255,0.08)'" onmouseout="this.style.background='none'">âˆ’</button>
          <div style="flex:1;text-align:center;font-family:'Bebas Neue',cursive;font-size:32px;letter-spacing:2px;color:#fff;line-height:52px;" id="maxPlayersCount">6</div>
          <button onclick="changeMaxPlayers(1)" style="background:none;border:none;color:#fff;font-size:22px;font-weight:900;width:44px;height:52px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.15s;" onmouseover="this.style.background='rgba(255,255,255,0.08)'" onmouseout="this.style.background='none'">+</button>
        </div>
        <div style="font-size:11px;color:var(--muted);margin-top:6px;">Min 3 Â· Max 15</div>
      </div>
    </div>

  </div>

  <!-- Word Categories -->
  <div class="card flex-col gap-12">
    <div class="card-label">Word Categories</div>
    <p style="font-size:12px;color:var(--muted);margin-top:-4px;">Pick which themes to play. Words are assigned secretly when game starts â€” even you won't know them until reveal!</p>
    <div class="chip-grid" id="categoryChips"></div>
    <div class="category-info">
      <span style="font-size:28px;" id="categoryInfoEmoji">ğŸ²</span>
      <div>
        <div style="font-size:13px;font-weight:700;color:#fff;" id="categoryInfoText">3 categories selected</div>
        <div style="font-size:11px;color:var(--muted);margin-top:2px;">Words will be randomly picked at game start</div>
      </div>
    </div>
  </div>

  <button class="btn btn-primary" onclick="createRoom()">
    <span class="btn-icon">ğŸš€</span> Create Room
  </button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCREEN: JOIN ROOM â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen hidden flex-col gap-20" id="screen-join">
  <div>
    <button onclick="goTo('home')" style="background:none;border:none;color:var(--muted);cursor:pointer;font-family:'Nunito',sans-serif;font-size:14px;padding:0;margin-bottom:16px;">â† Back</button>
    <div class="title-big" style="color:var(--blue);">JOIN ROOM</div>
    <p class="subtitle mt-4">Enter the code your host shared</p>
  </div>

  <div class="card flex-col gap-16">
    <div>
      <div class="card-label">Your Name</div>
      <input type="text" id="joinName" placeholder="Enter your name" maxlength="20"/>
    </div>
    <div>
      <div class="card-label">Pick Your Avatar</div>
      <div class="avatar-grid" id="joinAvatarGrid"></div>
    </div>
    <div>
      <div class="card-label">Room Code</div>
      <input type="text" id="joinCode" placeholder="e.g. A3X7K2" maxlength="6"
        style="font-family:'Bebas Neue',cursive;font-size:32px;letter-spacing:8px;text-align:center;text-transform:uppercase;"
        oninput="this.value=this.value.toUpperCase()" onkeydown="if(event.key==='Enter')joinRoom()"/>
    </div>
  </div>

  <button class="btn btn-blue" onclick="joinRoom()">
    <span class="btn-icon">ğŸ”‘</span> Join Game
  </button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCREEN: LOBBY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen hidden flex-col gap-16" id="screen-lobby" style="justify-content:flex-start;padding-top:32px;">
  <div style="text-align:center;">
    <div class="card-label">Room Code</div>
    <div class="code-display" id="lobbyCode">------</div>
    <button onclick="copyCode()" style="background:rgba(255,255,255,0.08);border:1px solid var(--border);border-radius:10px;padding:8px 20px;color:var(--muted);cursor:pointer;font-family:'Nunito',sans-serif;font-size:13px;margin-top:10px;" id="copyBtn">ğŸ“‹ Copy Code</button>
    <div style="margin-top:10px;font-size:12px;color:var(--muted);">Created by <span id="lobbyHostName" style="color:var(--purple);font-weight:700;"></span> ğŸ‘‘</div>
  </div>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
      <div class="card-label" style="margin:0;">Players</div>
      <div style="font-size:13px;color:var(--purple);" id="playerCountLabel">0 joined</div>
    </div>
    <div class="flex-col gap-8 scrollable" id="playerList"></div>
    <div style="margin-top:14px;text-align:center;font-size:13px;color:var(--muted);" id="waitingMsg">
      <span class="spin" style="display:inline-block;margin-right:6px;">âŸ³</span> Waiting for players...
    </div>
  </div>

  <!-- Settings summary -->
  <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center;" id="settingsBadges"></div>

  <div id="hostControls" class="hidden">
    <button class="btn btn-green" onclick="startGame()" id="startBtn">
      <span class="btn-icon">ğŸ®</span> Start Game
    </button>
    <p style="text-align:center;font-size:12px;color:var(--muted);margin-top:8px;">Need at least 3 players</p>
  </div>
  <div id="guestWaiting" class="hidden" style="text-align:center;color:var(--muted);font-size:14px;">
    â³ Waiting for host to start the game...
  </div>

  <button onclick="leaveRoom()" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:13px;padding:8px;font-family:'Nunito',sans-serif;">Leave Room</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCREEN: WORD REVEAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen hidden" id="screen-reveal" style="justify-content:flex-start;padding-top:24px;gap:14px;">

  <!-- Header row -->
  <div style="width:100%;display:flex;align-items:center;justify-content:space-between;">
    <div>
      <div class="card-label" style="margin:0;">Round <span id="revealRound">1</span></div>
      <div style="font-family:'Bebas Neue',cursive;font-size:28px;letter-spacing:3px;
        background:linear-gradient(135deg,#e8d8ff,#b56cff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">
        YOUR ROLE
      </div>
    </div>
    <div style="font-size:12px;color:var(--muted);text-align:right;line-height:1.5;">
      ğŸ™ˆ Keep your<br>screen hidden!
    </div>
  </div>

  <!-- Players ready strip (compact) -->
  <div style="width:100%;background:rgba(14,10,28,0.65);border:1px solid rgba(181,108,255,0.14);border-radius:14px;padding:10px 14px;backdrop-filter:blur(12px);">
    <div id="revealPlayerStrip" style="display:flex;flex-wrap:wrap;gap:6px;"></div>
    <div style="text-align:center;font-size:12px;color:var(--muted);margin-top:8px;" id="readyCount">0 / 0 ready</div>
  </div>

  <!-- COUNTDOWN shown first, then replaced by card -->
  <div id="countdownOverlay" style="width:100%;text-align:center;padding:32px 0;display:none;">
    <div style="font-size:12px;color:var(--muted);margin-bottom:12px;letter-spacing:3px;text-transform:uppercase;">Revealing in</div>
    <div class="countdown-num" id="countdownNum" style="color:var(--purple);">3</div>
  </div>

  <!-- ROLE CARD â€” shown after countdown -->
  <div id="cardFlipScene" style="width:100%;display:none;">

    <!-- Big role card -->
    <div id="wordRevealCard" class="word-card citizen w-full" style="padding:28px 24px;">

      <!-- Role + emoji in one row -->
      <div style="display:flex;align-items:center;justify-content:center;gap:16px;margin-bottom:16px;">
        <div id="revealRoleEmoji" style="font-size:52px;line-height:1;">ğŸ‘¤</div>
        <div class="word-role citizen" id="revealRoleName" style="font-size:clamp(36px,10vw,52px);">CITIZEN</div>
      </div>

      <!-- Divider -->
      <div style="width:50px;height:2px;background:rgba(255,255,255,0.12);margin:0 auto 16px;"></div>

      <!-- Word -->
      <div style="font-size:11px;color:var(--muted);letter-spacing:2px;text-transform:uppercase;margin-bottom:6px;">Your secret word</div>
      <div class="secret-word" id="revealWord" style="font-size:clamp(44px,13vw,68px);">CAR</div>
      <div class="word-hint" id="revealHint" style="margin-top:10px;font-size:13px;">Describe it without saying the word!</div>
    </div>

    <!-- Ready button -->
    <button class="btn btn-primary w-full" onclick="playerReady()" id="readyBtn" style="margin-top:12px;">
      âœ… I've Seen My Word â€” Ready!
    </button>

    <!-- Host override: shown only to host after everyone ready -->
    <div id="hostForceDiscussion" class="hidden" style="margin-top:10px;">
      <button class="btn btn-green w-full" onclick="forceStartDiscussion()">
        ğŸ‘‘ Everyone's Ready â€” Start Discussion!
      </button>
    </div>

  </div>

</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCREEN: DISCUSSION â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen hidden" id="screen-discussion" style="justify-content:flex-start;padding-top:28px;gap:16px;">
  <div style="width:100%;">
    <div class="card-label">Round <span id="discRound">1</span></div>
    <div class="title-big" style="font-size:32px;">DISCUSSION</div>
  </div>

  <!-- Live players strip -->
  <div style="width:100%;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:14px 16px;">
    <div class="card-label" style="margin-bottom:10px;">Players in this round</div>
    <div id="discPlayerStrip" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
  </div>

  <!-- Role reminder badge -->
  <div id="myRoleBadge" style="width:100%;padding:10px 16px;border-radius:14px;text-align:center;font-size:13px;font-weight:700;"></div>

  <!-- Emoji reactions -->
  <div style="width:100%;">
    <div class="card-label" style="margin-bottom:8px;">React Live ğŸ­</div>
    <div class="reaction-bar" id="reactionBar">
      <button class="reaction-btn" onclick="sendReaction('ğŸ˜‚')">ğŸ˜‚</button>
      <button class="reaction-btn" onclick="sendReaction('ğŸ¤”')">ğŸ¤”</button>
      <button class="reaction-btn" onclick="sendReaction('ğŸ‘€')">ğŸ‘€</button>
      <button class="reaction-btn" onclick="sendReaction('ğŸ˜±')">ğŸ˜±</button>
      <button class="reaction-btn" onclick="sendReaction('ğŸ¤¥')">ğŸ¤¥</button>
      <button class="reaction-btn" onclick="sendReaction('ğŸ‘†')">ğŸ‘†</button>
      <button class="reaction-btn" onclick="sendReaction('ğŸ”¥')">ğŸ”¥</button>
      <button class="reaction-btn" onclick="sendReaction('ğŸ’€')">ğŸ’€</button>
    </div>
    <!-- Floating reactions container -->
    <div id="reactionFeed" style="position:relative;height:0;overflow:visible;"></div>
  </div>

  <!-- Anonymous accusation -->
  <div style="width:100%;background:rgba(239,68,68,0.06);border:1px solid rgba(239,68,68,0.2);border-radius:18px;padding:16px;">
    <div class="card-label" style="color:var(--red);margin-bottom:10px;">ğŸ•µï¸ Anonymous Accusation</div>
    <div class="accusation-feed" id="accusationFeed"></div>
    <div style="display:flex;gap:8px;margin-top:10px;" id="accusationInputArea">
      <input type="text" id="accusationInput" placeholder="Send anonymous message..." maxlength="60"
        style="flex:1;font-size:14px;padding:10px 14px;"
        onkeydown="if(event.key==='Enter')sendAccusation()"/>
      <button onclick="sendAccusation()" style="background:rgba(239,68,68,0.2);border:1px solid rgba(239,68,68,0.4);border-radius:12px;padding:10px 16px;color:var(--red);cursor:pointer;font-weight:700;font-family:'Nunito',sans-serif;white-space:nowrap;font-size:13px;">Send ğŸ“¨</button>
    </div>
    <div id="accusationUsed" class="hidden" style="text-align:center;font-size:12px;color:var(--muted);margin-top:8px;">You've used your anonymous message</div>
  </div>

  <!-- Player order -->
  <div class="card" style="padding:16px 20px;">
    <div class="card-label">Speaking Order</div>
    <div class="flex-col gap-8 mt-8" id="discussionOrder"></div>
  </div>

  <!-- Host stop game button -->
  <div id="hostVoteBtn" class="hidden">
    <div style="display:flex;align-items:center;gap:10px;background:rgba(181,108,255,0.08);border:1px solid rgba(181,108,255,0.25);border-radius:14px;padding:10px 16px;margin-bottom:12px;backdrop-filter:blur(8px);">
      <span style="font-size:18px;">ğŸ‘‘</span>
      <span style="font-size:13px;color:rgba(181,108,255,0.9);">You're the host â€” tap below when discussion is done</span>
    </div>
    <button class="btn btn-red w-full" onclick="hostStopGame()" id="stopDiscBtn"
      style="animation:glowPulse 2s ease-in-out infinite;">
      ğŸ—³ï¸ Stop Discussion â€” Start Voting!
    </button>
  </div>
  <div id="guestVoteWait" class="hidden" style="text-align:center;padding:16px;background:rgba(14,10,28,0.65);border:1px solid rgba(181,108,255,0.15);border-radius:16px;font-size:14px;color:var(--muted);backdrop-filter:blur(12px);">
    <div id="discHostName" style="color:var(--purple);font-weight:700;font-size:15px;margin-bottom:4px;"></div>
    â³ Waiting for host to start voting...
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCREEN: VOTING â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen hidden" id="screen-vote" style="justify-content:flex-start;padding-top:28px;gap:16px;">
  <div style="text-align:center;width:100%;">
    <div class="card-label">Round <span id="voteRound">1</span></div>
    <div class="title-big" style="color:var(--yellow);">VOTE</div>
    <p class="subtitle">Who is the impostor? Tap to vote</p>
  </div>

  <!-- Live players strip -->
  <div style="width:100%;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:14px 16px;">
    <div class="card-label" style="margin-bottom:10px;">Players in this round</div>
    <div id="votePlayerStrip" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
  </div>

  <div style="background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.2);border-radius:16px;padding:12px 18px;width:100%;text-align:center;">
    <div style="font-size:13px;color:rgba(245,158,11,0.8);" id="voteStatus">Waiting for everyone to vote...</div>
    <div style="margin-top:6px;height:4px;background:rgba(255,255,255,0.08);border-radius:4px;overflow:hidden;">
      <div id="voteProgressBar" style="height:100%;background:var(--yellow);border-radius:4px;width:0%;transition:width 0.4s ease;"></div>
    </div>
  </div>

  <div class="vote-grid" id="voteGrid"></div>

  <div id="myVoteConfirmed" class="hidden" style="text-align:center;padding:14px;background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3);border-radius:16px;font-size:14px;color:var(--green);width:100%;">
    âœ… Your vote is in! Waiting for others...
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCREEN: RESULTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen hidden" id="screen-results" style="gap:0;padding:0;justify-content:flex-start;">
  <div id="confettiContainer" style="position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden;"></div>

  <!-- Personal outcome hero banner -->
  <div id="personalOutcomeBanner" style="width:100%;padding:40px 24px 28px;text-align:center;position:relative;z-index:1;">
    <div id="resultHeroEmoji" style="font-size:80px;margin-bottom:12px;animation:bounceIn 0.6s cubic-bezier(0.34,1.56,0.64,1);"></div>
    <div id="resultHeroTitle" style="font-family:'Bebas Neue',cursive;font-size:clamp(36px,10vw,52px);letter-spacing:4px;line-height:1;"></div>
    <div id="resultHeroSub" style="font-size:14px;margin-top:10px;opacity:0.7;line-height:1.5;"></div>
  </div>

  <div style="width:100%;padding:0 20px 100px;display:flex;flex-direction:column;gap:14px;position:relative;z-index:1;">

    <!-- Who voted correctly -->
    <div id="correctVotersCard" class="card" style="display:none;">
      <div class="card-label" style="margin-bottom:12px;">ğŸ¯ Correct Voters</div>
      <div id="correctVotersList" class="flex-col gap-8"></div>
    </div>

    <!-- Truth reveal -->
    <div class="card">
      <div class="card-label" style="margin-bottom:12px;">ğŸ” The Truth</div>
      <div style="display:flex;align-items:center;gap:0;justify-content:center;background:rgba(255,255,255,0.03);border-radius:14px;overflow:hidden;">
        <div style="flex:1;padding:16px;text-align:center;border-right:1px solid rgba(255,255,255,0.08);">
          <div style="font-size:10px;color:var(--green);text-transform:uppercase;letter-spacing:2px;margin-bottom:6px;">Citizens had</div>
          <div style="font-family:'Bebas Neue',cursive;font-size:30px;color:var(--green);letter-spacing:2px;" id="revealCitizenWord">CAR</div>
        </div>
        <div style="flex:1;padding:16px;text-align:center;">
          <div style="font-size:10px;color:var(--red);text-transform:uppercase;letter-spacing:2px;margin-bottom:6px;">Impostor had</div>
          <div style="font-family:'Bebas Neue',cursive;font-size:30px;color:var(--red);letter-spacing:2px;" id="revealImpostorWord">BIKE</div>
        </div>
      </div>
    </div>

    <!-- All players with roles + vote -->
    <div class="card">
      <div class="card-label" style="margin-bottom:12px;">ğŸ‘¥ All Players</div>
      <div class="flex-col gap-8" id="allPlayersReveal"></div>
    </div>

    <!-- Action buttons -->
    <div style="display:flex;gap:12px;width:100%;">
      <button class="btn btn-secondary" style="flex:1;" onclick="goTo('leaderboard')">â† Leaderboard</button>
      <button class="btn btn-primary" style="flex:2;" onclick="playAgain()" id="playAgainBtn">ğŸ”„ Next Round</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCREEN: LEADERBOARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen hidden" id="screen-leaderboard" style="justify-content:flex-start;padding-top:32px;gap:16px;">
  <div style="text-align:center;width:100%;">
    <div class="card-label">After Round <span id="lbRound">1</span></div>
    <div class="title-big" style="color:var(--yellow);font-size:clamp(36px,10vw,52px);">ğŸ† LEADERBOARD</div>
    <p class="subtitle mt-4">Scores so far</p>
  </div>

  <!-- Score list -->
  <div style="width:100%;display:flex;flex-direction:column;gap:10px;" id="leaderboardList"></div>

  <!-- Scoring legend -->
  <div style="width:100%;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:16px;padding:14px 18px;">
    <div class="card-label" style="margin-bottom:8px;">How points work</div>
    <div style="display:flex;flex-direction:column;gap:6px;font-size:13px;color:rgba(255,255,255,0.55);">
      <div style="display:flex;justify-content:space-between;"><span>ğŸ¯ Correctly voted impostor</span><span style="color:var(--green);font-weight:700;">+3 pts</span></div>
      <div style="display:flex;justify-content:space-between;"><span>ğŸ•µï¸ Impostor survived undetected</span><span style="color:var(--red);font-weight:700;">+4 pts</span></div>
      <div style="display:flex;justify-content:space-between;"><span>ğŸ˜¬ Wrong vote (innocent voted out)</span><span style="color:var(--muted);font-weight:700;">+0 pts</span></div>
    </div>
  </div>

  <!-- Buttons -->
  <div id="lbHostControls" class="hidden" style="width:100%;display:flex;flex-direction:column;gap:10px;">
    <button class="btn btn-secondary w-full" onclick="goToResults()">ğŸ“‹ See Round Details</button>
    <button class="btn btn-primary w-full" onclick="playAgain()">ğŸ”„ Next Round</button>
    <p style="text-align:center;font-size:12px;color:var(--muted);">Only host can start next round</p>
  </div>
  <div id="lbGuestWait" class="hidden" style="text-align:center;padding:16px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:16px;font-size:14px;color:var(--muted);">
    <div style="margin-bottom:6px;">â³ Waiting for host to start next round...</div>
    <button onclick="goToResults()" style="background:none;border:none;color:var(--blue);cursor:pointer;font-family:'Nunito',sans-serif;font-size:13px;text-decoration:underline;">ğŸ“‹ See round details</button>
  </div>
  <button class="btn btn-secondary w-full" onclick="goHome()">ğŸ  Leave Game</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• JAVASCRIPT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
// â”€â”€â”€ Word Pairs Database â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const WORD_PAIRS = {
  Vehicles: [["Car","Bike"],["Bus","Train"],["Plane","Helicopter"],["Ship","Boat"],["Truck","Van"],["Motorcycle","Scooter"]],
  Food: [["Pizza","Burger"],["Sushi","Ramen"],["Cake","Pie"],["Coffee","Tea"],["Rice","Bread"],["Mango","Orange"],["Ice Cream","Gelato"]],
  Animals: [["Dog","Cat"],["Lion","Tiger"],["Elephant","Rhino"],["Eagle","Hawk"],["Dolphin","Whale"],["Rabbit","Squirrel"],["Monkey","Gorilla"]],
  Sports: [["Cricket","Baseball"],["Football","Rugby"],["Tennis","Badminton"],["Swimming","Diving"],["Boxing","Wrestling"],["Golf","Hockey"]],
  Places: [["Beach","Lake"],["Mountain","Hill"],["City","Town"],["Forest","Jungle"],["Desert","Savanna"],["Castle","Palace"]],
  Electronics: [["Phone","Tablet"],["Laptop","Desktop"],["TV","Monitor"],["Camera","Webcam"],["Headphones","Earbuds"],["Keyboard","Mouse"]],
  Clothes: [["Shirt","Jacket"],["Shoes","Boots"],["Hat","Cap"],["Jeans","Trousers"],["Dress","Skirt"],["Gloves","Mittens"]],
  Nature: [["Rain","Snow"],["Sun","Moon"],["River","Stream"],["Tree","Bush"],["Rose","Lily"],["Gold","Silver"]],
};

// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let roomRef = null;
let myId = null;
let myName = "";
let myAvatar = "ğŸ­";
let isHost = false;
let currentRoom = null;
let selectedCategories = ["Vehicles","Food","Animals"];
let myVote = null;
let soundEnabled = true;
let accusationSent = false;

const AVATARS = ["ğŸ­","ğŸ•µï¸","ğŸ‘»","ğŸ¤–","ğŸ¦Š","ğŸº","ğŸ¦","ğŸ¯","ğŸƒ","ğŸ‘½","ğŸ¤¡","ğŸ¦¸","ğŸ§™","ğŸ¥·","ğŸ¤ ","ğŸ˜ˆ","ğŸ‘¾","ğŸ¦","ğŸ¸","ğŸ¦„","ğŸ‰","ğŸ’€"];

// â”€â”€â”€ Firebase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let firebaseConnected = false;
let db = null;

// In-memory fallback DB
const memDB = {};
const memListeners = {};

const storage = {
  set(path, val) {
    if (firebaseConnected && db) {
      return db.ref(path).set(val);
    } else {
      setNested(memDB, path, val);
      triggerListeners(path, val);
      return Promise.resolve();
    }
  },
  update(path, val) {
    if (firebaseConnected && db) {
      return db.ref(path).update(val);
    } else {
      const cur = getNested(memDB, path) || {};
      setNested(memDB, path, {...cur, ...val});
      triggerListeners(path, getNested(memDB, path));
      return Promise.resolve();
    }
  },
  get(path) {
    if (firebaseConnected && db) {
      return db.ref(path).once('value').then(s => s.val());
    } else {
      return Promise.resolve(getNested(memDB, path));
    }
  },
  on(path, cb) {
    if (firebaseConnected && db) {
      const ref = db.ref(path);
      ref.on('value', snap => cb(snap.val()));
      return () => ref.off();
    } else {
      if (!memListeners[path]) memListeners[path] = [];
      memListeners[path].push(cb);
      cb(getNested(memDB, path));
      return () => { memListeners[path] = memListeners[path].filter(l => l !== cb); };
    }
  },
  remove(path) {
    if (firebaseConnected && db) {
      return db.ref(path).remove();
    } else {
      deleteNested(memDB, path);
      return Promise.resolve();
    }
  }
};

function setNested(obj, path, val) {
  const parts = path.split('/').filter(Boolean);
  let cur = obj;
  for (let i = 0; i < parts.length - 1; i++) {
    if (!cur[parts[i]]) cur[parts[i]] = {};
    cur = cur[parts[i]];
  }
  cur[parts[parts.length - 1]] = val;
}
function getNested(obj, path) {
  return path.split('/').filter(Boolean).reduce((cur, k) => cur && cur[k], obj);
}
function deleteNested(obj, path) {
  const parts = path.split('/').filter(Boolean);
  let cur = obj;
  for (let i = 0; i < parts.length - 1; i++) cur = cur && cur[parts[i]];
  if (cur) delete cur[parts[parts.length - 1]];
}
function triggerListeners(path, val) {
  Object.keys(memListeners).forEach(lpath => {
    if (path.startsWith(lpath) || lpath.startsWith(path)) {
      memListeners[lpath].forEach(cb => cb(getNested(memDB, lpath)));
    }
  });
}

// â”€â”€â”€ UI Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function goTo(screen) {
  document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
  document.getElementById('screen-' + screen).classList.remove('hidden');
}

let toastTimer;
function showToast(msg, type='info') {
  let t = document.querySelector('.toast');
  if (t) t.remove();
  t = document.createElement('div');
  t.className = `toast ${type}`;
  t.textContent = msg;
  document.body.appendChild(t);
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.remove(), 3000);
}

function rand(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
function genCode() { return Math.random().toString(36).substring(2,8).toUpperCase(); }
function genId() { return Date.now().toString(36) + Math.random().toString(36).substring(2,5); }

const AVATAR_COLORS = ['#a855f7','#3b82f6','#22c55e','#ef4444','#f59e0b','#ec4899','#14b8a6','#f97316','#8b5cf6','#06b6d4'];
function getColor(i) { return AVATAR_COLORS[i % AVATAR_COLORS.length]; }

// â”€â”€â”€ Firebase Setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openFirebaseModal() { document.getElementById('firebaseModal').classList.remove('hidden'); }
function closeFirebaseModal() { document.getElementById('firebaseModal').classList.add('hidden'); }

function resetFirebase() {
  localStorage.removeItem('impostor_firebase_config');
  firebaseConnected = false;
  db = null;
  document.getElementById('fbStatusDot').className = 'status-dot';
  document.getElementById('fbStatusDot').style.background = 'var(--yellow)';
  document.getElementById('fbStatusText').innerHTML = 'Not connected â€” <span style="color:var(--blue);cursor:pointer;text-decoration:underline;" onclick="openFirebaseModal()">Setup Firebase for multiplayer</span>';
  document.getElementById('fbResetBtn').style.display = 'none';
  showToast('Firebase config cleared', 'info');
}

function showConnectedStatus() {
  document.getElementById('fbStatusDot').className = 'status-dot green';
  document.getElementById('fbStatusText').innerHTML = '<span style="color:var(--green)">ğŸ”¥ Firebase connected â€” Cross-phone multiplayer active!</span>';
  document.getElementById('fbResetBtn').style.display = 'inline';
}

function applyFirebaseConfig() {
  const raw = document.getElementById('firebaseConfigInput').value.trim();
  try {
    const match = raw.match(/\{[\s\S]*\}/);
    if (!match) throw new Error('Invalid format');
    const config = eval('(' + match[0] + ')');
    if (!config.apiKey || !config.databaseURL) throw new Error('Missing apiKey or databaseURL');

    if (firebase.apps.length) firebase.apps.forEach(a => a.delete());
    firebase.initializeApp(config);
    db = firebase.database();
    firebaseConnected = true;

    // âœ… Save to localStorage so it auto-connects next time
    localStorage.setItem('impostor_firebase_config', JSON.stringify(config));

    showConnectedStatus();
    closeFirebaseModal();
    showToast('Firebase connected! Auto-saves for next time ğŸ‰', 'success');
  } catch(e) {
    showToast('Invalid config: ' + e.message, 'error');
  }
}

// â”€â”€â”€ Category Chips â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCategoryChips() {
  const container = document.getElementById('categoryChips');
  container.innerHTML = '';
  Object.keys(WORD_PAIRS).forEach(cat => {
    const chip = document.createElement('button');
    chip.className = 'chip ' + (selectedCategories.includes(cat) ? 'on' : 'off');
    chip.textContent = cat;
    chip.onclick = () => {
      if (selectedCategories.includes(cat)) {
        if (selectedCategories.length > 1) selectedCategories = selectedCategories.filter(c => c !== cat);
      } else { selectedCategories.push(cat); }
      renderCategoryChips();
      updateCategoryInfo();
    };
    container.appendChild(chip);
  });
}

function updateCategoryInfo() {
  const count = selectedCategories.length;
  const emojis = { Vehicles:'ğŸš—', Food:'ğŸ•', Animals:'ğŸ¾', Sports:'âš½', Places:'ğŸŒ', Electronics:'ğŸ“±', Clothes:'ğŸ‘•', Nature:'ğŸŒ¿' };
  const emoji = count === 1 ? (emojis[selectedCategories[0]] || 'ğŸ²') : 'ğŸ²';
  document.getElementById('categoryInfoEmoji').textContent = emoji;
  document.getElementById('categoryInfoText').textContent =
    count === 1
      ? `"${selectedCategories[0]}" selected`
      : `${count} categories selected`;
}

let impostorValue = 1;
let maxPlayersValue = 6;

function changeImpostors(delta) {
  impostorValue = Math.max(1, Math.min(5, impostorValue + delta));
  document.getElementById('impostorCount').textContent = impostorValue;
}

function changeMaxPlayers(delta) {
  maxPlayersValue = Math.max(3, Math.min(15, maxPlayersValue + delta));
  document.getElementById('maxPlayersCount').textContent = maxPlayersValue;
}
async function createRoom() {
  const name = document.getElementById('createName').value.trim();
  if (!name) return showToast('Enter your name!', 'error');

  myId = genId();
  myName = name;
  isHost = true;

  const code = genCode();
  const room = {
    code,
    hostId: myId,
    phase: 'lobby',
    impostors: impostorValue,
    maxPlayers: maxPlayersValue,
    categories: selectedCategories,
    round: 0,
    players: { [myId]: { name, id: myId, avatar: myAvatar, ready: false, vote: null, joinedAt: Date.now() } },
    citizenWord: '', impostorWord: '', impostorIds: [],
  };

  await storage.set(`rooms/${code}`, room);
  listenToRoom(code);
  goTo('lobby');
  showToast('Room created! Share the code ğŸ‰', 'success');
}

// â”€â”€â”€ JOIN ROOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function joinRoom() {
  const name = document.getElementById('joinName').value.trim();
  const code = document.getElementById('joinCode').value.trim().toUpperCase();
  if (!name) return showToast('Enter your name!', 'error');
  if (!code) return showToast('Enter room code!', 'error');

  const room = await storage.get(`rooms/${code}`);
  if (!room) return showToast('Room not found!', 'error');
  if (room.phase !== 'lobby') return showToast('Game already started!', 'error');
  const currentCount = Object.keys(room.players || {}).length;
  const maxAllowed = room.maxPlayers || 15;
  if (currentCount >= maxAllowed) return showToast(`Room is full! (${maxAllowed} players max)`, 'error');

  myId = genId();
  myName = name;
  isHost = false;

  await storage.update(`rooms/${code}/players`, {
    [myId]: { name, id: myId, avatar: myAvatar, ready: false, vote: null, joinedAt: Date.now() }
  });

  listenToRoom(code);
  goTo('lobby');
}

// â”€â”€â”€ LISTEN TO ROOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let unsubscribe = null;
function listenToRoom(code) {
  if (unsubscribe) unsubscribe();
  unsubscribe = storage.on(`rooms/${code}`, (room) => {
    if (!room) return;
    currentRoom = room;
    handleRoomUpdate(room);
  });
}

function handleRoomUpdate(room) {
  // If I got kicked, go home
  if (room.kicked && room.kicked[myId]) {
    if (unsubscribe) { unsubscribe(); unsubscribe = null; }
    currentRoom = null;
    showToast('You were removed from the room', 'error');
    goTo('home');
    return;
  }

  const phase = room.phase;
  const currentScreen = [...document.querySelectorAll('.screen')].find(s => !s.classList.contains('hidden'))?.id;

  if (phase === 'lobby') {
    renderLobby(room);
    if (currentScreen !== 'screen-lobby') goTo('lobby');
  }
  else if (phase === 'reveal') {
    if (currentScreen !== 'screen-reveal') {
      revealDone = false;
      renderReveal(room); goTo('reveal');
    } else renderReveal(room);
    // Auto-advance to discussion when all players ready (host fires it)
    checkAllReady(room);
  }
  else if (phase === 'discussion') {
    if (currentScreen !== 'screen-discussion') {
      accusationSent = false;
      document.getElementById('accusationInputArea').classList.remove('hidden');
      document.getElementById('accusationUsed').classList.add('hidden');
      document.getElementById('accusationFeed').innerHTML = '';
      renderDiscussion(room); goTo('discussion');
      listenReactions(room.code);
      listenAccusations(room.code);
    } else renderDiscussion(room);
  }
  else if (phase === 'voting') {
    myVote = null;
    const confirmed = document.getElementById('myVoteConfirmed');
    if (confirmed) confirmed.classList.add('hidden');
    if (currentScreen !== 'screen-vote') {
      playSound('suspense');
      renderVoting(room); goTo('vote');
    } else renderVoting(room);
  }
  else if (phase === 'leaderboard') {
    if (currentScreen !== 'screen-leaderboard') {
      renderLeaderboard(room); goTo('leaderboard');
      playSound('vote');
    } else renderLeaderboard(room);
  }
  else if (phase === 'results') {
    if (currentScreen !== 'screen-results') { renderResults(room); goTo('results'); }
  }
}

// â”€â”€â”€ LOBBY RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderLobby(room) {
  document.getElementById('lobbyCode').textContent = room.code;
  const players = Object.values(room.players || {}).sort((a,b) => a.joinedAt - b.joinedAt);
  const hostPlayer = players.find(p => p.id === room.hostId);
  document.getElementById('lobbyHostName').textContent = hostPlayer?.name || 'Host';
  const maxAllowed = room.maxPlayers || 15;
  document.getElementById('playerCountLabel').textContent = `${players.length} / ${maxAllowed} joined`;

  const list = document.getElementById('playerList');
  list.innerHTML = '';
  players.forEach((p, i) => {
    const div = document.createElement('div');
    div.className = 'player-item';
    const isMe = p.id === myId;
    const isPlayerHost = p.id === room.hostId;
    const iAmHost = room.hostId === myId;
    const avatarDisplay = p.avatar || p.name[0].toUpperCase();
    const isEmoji = p.avatar && p.avatar.length > 0;

    div.innerHTML = `
      <div class="player-avatar" style="background:${isEmoji ? 'rgba(255,255,255,0.08)' : getColor(i)};font-size:${isEmoji ? '22px' : '14px'};">${avatarDisplay}</div>
      <div style="flex:1;">
        <div class="player-name">${p.name}${isMe ? ' <span style="color:var(--muted);font-size:12px;">(You)</span>' : ''}</div>
        ${isPlayerHost ? '<div class="player-badge">ğŸ‘‘ Host</div>' : ''}
      </div>
      ${room.scores && room.scores[p.id] ? `<div style="font-family:'Bebas Neue',cursive;font-size:18px;color:var(--yellow);margin-right:${(iAmHost && !isPlayerHost && !isMe)?'8px':'0'};">${room.scores[p.id]}pts</div>` : ''}
      ${iAmHost && !isPlayerHost && !isMe
        ? `<button onclick="kickPlayer('${p.id}','${p.name}')"
            style="background:rgba(239,68,68,0.15);border:1px solid rgba(239,68,68,0.3);
            border-radius:10px;padding:5px 12px;color:#ef4444;cursor:pointer;
            font-family:'Nunito',sans-serif;font-size:12px;font-weight:700;
            transition:all 0.2s;flex-shrink:0;"
            onmouseover="this.style.background='rgba(239,68,68,0.3)'"
            onmouseout="this.style.background='rgba(239,68,68,0.15)'">
            âœ• Kick
          </button>`
        : `<div class="player-status">${isPlayerHost ? 'ğŸ‘‘' : 'âœ…'}</div>`
      }
    `;
    list.appendChild(div);
  });

  // Settings badges
  const badges = document.getElementById('settingsBadges');
  badges.innerHTML = [
    `âš¡ ${room.impostors} Impostor${room.impostors>1?'s':''}`,
    `ğŸ‘¥ ${room.maxPlayers || 15} Players Max`,
    `ğŸ“š ${(room.categories||[]).length} Categor${(room.categories||[]).length>1?'ies':'y'}`,
  ].map(b => `<span style="background:rgba(255,255,255,0.07);border:1px solid var(--border);border-radius:20px;padding:6px 14px;font-size:12px;color:var(--muted);">${b}</span>`).join('');

  if (room.hostId === myId) {
    document.getElementById('hostControls').classList.remove('hidden');
    document.getElementById('guestWaiting').classList.add('hidden');
    document.getElementById('startBtn').disabled = players.length < 3;
  } else {
    document.getElementById('hostControls').classList.add('hidden');
    document.getElementById('guestWaiting').classList.remove('hidden');
  }
  document.getElementById('waitingMsg').style.display = players.length >= 3 ? 'none' : 'block';
}

function copyCode() {
  const code = currentRoom?.code || '';
  navigator.clipboard?.writeText(code).catch(()=>{});
  const btn = document.getElementById('copyBtn');
  btn.textContent = 'âœ… Copied!';
  setTimeout(() => btn.textContent = 'ğŸ“‹ Copy Code', 2000);
}

async function kickPlayer(playerId, playerName) {
  if (!currentRoom || currentRoom.hostId !== myId) return;
  // Show confirm toast style inline â€” no browser confirm() on mobile
  const confirmed = await showKickConfirm(playerName);
  if (!confirmed) return;
  await storage.remove(`rooms/${currentRoom.code}/players/${playerId}`);
  // Also add to kicked list so their phone redirects home
  await storage.update(`rooms/${currentRoom.code}/kicked`, { [playerId]: true });
  showToast(`${playerName} removed from room`, 'info');
}

function showKickConfirm(name) {
  return new Promise(resolve => {
    // Remove any existing confirm
    const old = document.getElementById('kickConfirmOverlay');
    if (old) old.remove();

    const overlay = document.createElement('div');
    overlay.id = 'kickConfirmOverlay';
    overlay.style.cssText = `
      position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(8px);
      z-index:999;display:flex;align-items:center;justify-content:center;padding:24px;
    `;
    overlay.innerHTML = `
      <div style="background:#12131f;border:1px solid rgba(239,68,68,0.3);border-radius:24px;
        padding:28px 24px;width:100%;max-width:340px;text-align:center;">
        <div style="font-size:48px;margin-bottom:12px;">ğŸšª</div>
        <div style="font-family:'Bebas Neue',cursive;font-size:28px;letter-spacing:2px;color:#ef4444;margin-bottom:8px;">REMOVE PLAYER</div>
        <div style="font-size:15px;color:rgba(255,255,255,0.6);margin-bottom:24px;line-height:1.5;">
          Remove <strong style="color:#fff;">${name}</strong> from the room?<br>
          <span style="font-size:12px;">They won't be able to rejoin.</span>
        </div>
        <div style="display:flex;gap:12px;">
          <button id="kickCancel" style="flex:1;padding:14px;border-radius:14px;border:1px solid rgba(255,255,255,0.15);
            background:rgba(255,255,255,0.07);color:#fff;cursor:pointer;font-family:'Nunito',sans-serif;font-weight:700;font-size:14px;">
            Cancel
          </button>
          <button id="kickConfirm" style="flex:1;padding:14px;border-radius:14px;border:none;
            background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff;cursor:pointer;
            font-family:'Nunito',sans-serif;font-weight:700;font-size:14px;
            box-shadow:0 8px 24px rgba(239,68,68,0.4);">
            âœ• Remove
          </button>
        </div>
      </div>
    `;
    document.body.appendChild(overlay);

    document.getElementById('kickConfirm').onclick = () => { overlay.remove(); resolve(true); };
    document.getElementById('kickCancel').onclick = () => { overlay.remove(); resolve(false); };
    overlay.onclick = (e) => { if (e.target === overlay) { overlay.remove(); resolve(false); } };
  });
}

// â”€â”€â”€ START GAME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startGame() {
  const room = currentRoom;
  if (!room) return;
  const players = Object.values(room.players || {});
  if (players.length < 3) return showToast('Need at least 3 players!', 'error');

  const pool = (room.categories||['Vehicles']).flatMap(c => WORD_PAIRS[c] || []);
  const pair = rand(pool);

  const shuffled = [...players].sort(() => Math.random() - 0.5);
  const impostorCount = Math.min(room.impostors, Math.floor(players.length / 3));
  const impostorIds = shuffled.slice(0, impostorCount).map(p => p.id);

  // Reset ready
  const updatedPlayers = {};
  players.forEach(p => { updatedPlayers[p.id] = {...p, ready: false, vote: null}; });

  await storage.update(`rooms/${room.code}`, {
    phase: 'reveal',
    citizenWord: pair[0],
    impostorWord: pair[1],
    impostorIds,
    players: updatedPlayers,
    round: (room.round || 0) + 1,
    votes: {},
    eliminated: null,
    kicked: {},
  });
}

// â”€â”€â”€ PLAYER STRIP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Shows all players in round with status indicator
// mode: 'ready' (reveal screen) | 'talking' (discussion) | 'voted' (voting)
function renderPlayerStrip(containerId, players, votes, mode) {
  const container = document.getElementById(containerId);
  if (!container) return;
  container.innerHTML = '';
  players.forEach((p, i) => {
    let statusEmoji = '';
    let statusColor = 'rgba(255,255,255,0.15)';
    if (mode === 'ready') {
      statusEmoji = p.ready ? 'âœ…' : 'â³';
      statusColor = p.ready ? 'rgba(34,197,94,0.25)' : 'rgba(255,255,255,0.06)';
    } else if (mode === 'talking') {
      statusEmoji = '';
      statusColor = p.id === myId ? 'rgba(168,85,247,0.2)' : 'rgba(255,255,255,0.06)';
    } else if (mode === 'voted') {
      const hasVoted = votes && votes[p.id];
      statusEmoji = hasVoted ? 'ğŸ—³ï¸' : 'â³';
      statusColor = hasVoted ? 'rgba(245,158,11,0.2)' : 'rgba(255,255,255,0.06)';
    }

    const avatarDisplay = p.avatar || p.name[0].toUpperCase();
    const isEmoji = p.avatar && p.avatar.length > 0;

    const chip = document.createElement('div');
    chip.style.cssText = `
      display:flex;align-items:center;gap:6px;
      background:${statusColor};
      border:1px solid ${p.id === myId ? 'rgba(168,85,247,0.4)' : 'rgba(255,255,255,0.08)'};
      border-radius:20px;padding:5px 12px 5px 6px;
      transition:background 0.3s;
    `;
    chip.innerHTML = `
      <div style="width:28px;height:28px;border-radius:50%;background:${isEmoji ? 'rgba(255,255,255,0.08)' : getColor(i)};display:flex;align-items:center;justify-content:center;font-size:${isEmoji ? '18px' : '11px'};font-weight:900;color:#fff;flex-shrink:0;">${avatarDisplay}</div>
      <span style="font-size:13px;font-weight:700;color:${p.id === myId ? 'rgba(168,85,247,0.9)' : '#fff'};">${p.name}${p.id === myId ? ' (You)' : ''}</span>
      ${statusEmoji ? `<span style="font-size:13px;margin-left:2px;">${statusEmoji}</span>` : ''}
    `;
    container.appendChild(chip);
  });
}

// â”€â”€â”€ REVEAL RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let revealDone = false;
function renderReveal(room) {
  const amImpostor = (room.impostorIds || []).includes(myId);
  const myWord = amImpostor ? room.impostorWord : room.citizenWord;

  document.getElementById('revealRound').textContent = room.round || 1;
  const card = document.getElementById('wordRevealCard');
  card.className = 'word-card w-full ' + (amImpostor ? 'impostor' : 'citizen');
  document.getElementById('revealRoleEmoji').textContent = amImpostor ? 'ğŸ•µï¸' : (myAvatar || 'ğŸ‘¤');
  document.getElementById('revealRoleName').textContent = amImpostor ? 'IMPOSTOR' : 'CITIZEN';
  document.getElementById('revealRoleName').className = 'word-role ' + (amImpostor ? 'impostor' : 'citizen');
  document.getElementById('revealWord').textContent = amImpostor ? '???' : myWord;
  document.getElementById('revealWord').style.color = amImpostor ? '#ef4444' : '';
  document.getElementById('revealHint').textContent = amImpostor
    ? 'You don\'t know the word. Try to blend in!'
    : `Describe "${myWord}" without saying it!`;

  const players = Object.values(room.players || {}).sort((a,b) => a.joinedAt - b.joinedAt);
  const readyCount = players.filter(p => p.ready).length;
  const allReady = readyCount === players.length && players.length > 0;
  renderPlayerStrip('revealPlayerStrip', players, null, 'ready');
  document.getElementById('readyCount').textContent = `${readyCount} / ${players.length} ready`;

  // Show host override button if all ready (fallback if auto-advance fails)
  const hostOverride = document.getElementById('hostForceDiscussion');
  if (hostOverride) {
    hostOverride.classList.toggle('hidden', !(allReady && room.hostId === myId));
  }

  // Trigger countdown only once when screen first shown
  if (!revealDone) {
    revealDone = true;
    startRevealCountdown();
  }
}

async function playerReady() {
  if (!currentRoom) return;

  // Mark self as ready in Firebase
  await storage.update(`rooms/${currentRoom.code}/players/${myId}`, { ready: true });

  const btn = document.getElementById('readyBtn');
  if (btn) {
    btn.disabled = true;
    btn.textContent = 'â³ Waiting for others...';
    btn.style.opacity = '0.6';
  }
  playSound('click');

  // If I'm the host, also check immediately after a small delay
  if (currentRoom.hostId === myId) {
    setTimeout(async () => {
      const fresh = await storage.get(`rooms/${currentRoom?.code}`);
      if (fresh) checkAllReady(fresh);
    }, 600);
  }
}

// Called every time room updates on reveal screen â€” host auto-advances when all ready
async function checkAllReady(room) {
  if (!room || room.hostId !== myId) return;   // only host fires phase change
  if (room.phase !== 'reveal') return;          // only on reveal screen
  const players = Object.values(room.players || {});
  if (players.length < 2) return;
  const allReady = players.every(p => p.ready);
  if (allReady) {
    await storage.update(`rooms/${currentRoom.code}`, { phase: 'discussion' });
  }
}

async function forceStartDiscussion() {
  if (!currentRoom || currentRoom.hostId !== myId) return;
  playSound('click');
  await storage.update(`rooms/${currentRoom.code}`, { phase: 'discussion' });
}

// â”€â”€â”€ DISCUSSION RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDiscussion(room) {
  document.getElementById('discRound').textContent = room.round || 1;

  // Define players FIRST so they're available everywhere below
  const players = Object.values(room.players || {}).sort((a,b) => a.joinedAt - b.joinedAt);
  const amImpostor = (room.impostorIds || []).includes(myId);

  // Role reminder badge
  const badge = document.getElementById('myRoleBadge');
  if (amImpostor) {
    badge.style.cssText = 'width:100%;padding:10px 16px;border-radius:14px;text-align:center;font-size:13px;font-weight:700;background:rgba(255,77,109,0.12);border:1px solid rgba(255,77,109,0.3);color:var(--red);';
    badge.innerHTML = 'ğŸ•µï¸ You are the <strong>IMPOSTOR</strong> â€” Blend in, don\'t reveal you don\'t know!';
  } else {
    badge.style.cssText = 'width:100%;padding:10px 16px;border-radius:14px;text-align:center;font-size:13px;font-weight:700;background:rgba(52,216,136,0.1);border:1px solid rgba(52,216,136,0.3);color:var(--green);';
    badge.innerHTML = `ğŸ‘¤ <strong>CITIZEN</strong> â€” Your word: <span style="font-family:'Bebas Neue',cursive;font-size:18px;letter-spacing:2px;">${room.citizenWord}</span>`;
  }

  // Host vs guest controls
  const iAmHost = room.hostId === myId;
  document.getElementById('hostVoteBtn').classList.toggle('hidden', !iAmHost);
  document.getElementById('guestVoteWait').classList.toggle('hidden', iAmHost);
  if (!iAmHost) {
    const hostPlayer = players.find(p => p.id === room.hostId);
    const discHostEl = document.getElementById('discHostName');
    if (discHostEl) discHostEl.textContent = `ğŸ‘‘ ${hostPlayer?.name || 'Host'} decides when to vote`;
  }

  // Player strips
  renderPlayerStrip('discPlayerStrip', players, null, 'talking');

  // Speaking order
  const order = document.getElementById('discussionOrder');
  order.innerHTML = '';
  players.forEach((p, i) => {
    const avatarDisplay = p.avatar || p.name[0].toUpperCase();
    const isEmoji = p.avatar && p.avatar.length > 0;
    const suffix = ['st','nd','rd'][i] || 'th';
    const div = document.createElement('div');
    div.style.cssText = 'display:flex;align-items:center;gap:10px;padding:8px 12px;background:rgba(14,10,28,0.5);border:1px solid rgba(181,108,255,0.1);border-radius:12px;backdrop-filter:blur(8px);';
    div.innerHTML = `
      <div style="width:28px;height:28px;border-radius:50%;background:${isEmoji?'rgba(255,255,255,0.08)':getColor(i)};display:flex;align-items:center;justify-content:center;font-size:${isEmoji?'16px':'11px'};font-weight:900;flex-shrink:0;">${avatarDisplay}</div>
      <span style="font-size:14px;font-weight:700;color:${p.id===myId?'var(--purple)':'var(--text)'};">${p.name}${p.id===myId?' (You)':''}</span>
      <span style="margin-left:auto;font-size:12px;color:var(--muted);font-family:'Bebas Neue',cursive;letter-spacing:1px;">${i+1}${suffix}</span>
    `;
    order.appendChild(div);
  });
}

async function hostStopGame() {
  if (!currentRoom || currentRoom.hostId !== myId) return;

  // Show confirmation overlay
  const confirmed = await new Promise(resolve => {
    const overlay = document.createElement('div');
    overlay.style.cssText = `
      position:fixed;inset:0;background:rgba(0,0,0,0.75);backdrop-filter:blur(8px);
      z-index:9999;display:flex;align-items:center;justify-content:center;padding:24px;
    `;
    overlay.innerHTML = `
      <div style="background:rgba(14,10,28,0.95);border:1px solid rgba(181,108,255,0.3);
        border-radius:24px;padding:28px 24px;width:100%;max-width:340px;text-align:center;
        box-shadow:0 24px 80px rgba(0,0,0,0.6),0 0 0 1px rgba(181,108,255,0.1);">
        <div style="font-size:48px;margin-bottom:12px;">ğŸ—³ï¸</div>
        <div style="font-family:'Bebas Neue',cursive;font-size:28px;letter-spacing:3px;
          background:linear-gradient(135deg,#e8d8ff,#b56cff);-webkit-background-clip:text;
          -webkit-text-fill-color:transparent;margin-bottom:8px;">START VOTING?</div>
        <p style="font-size:14px;color:rgba(220,210,255,0.5);margin-bottom:24px;line-height:1.6;">
          This will end the discussion and send everyone to vote. Make sure everyone has given their clue!
        </p>
        <div style="display:flex;gap:12px;">
          <button id="stopCancel" style="flex:1;padding:14px;border-radius:14px;border:1px solid rgba(255,255,255,0.1);
            background:rgba(255,255,255,0.06);color:#fff;cursor:pointer;font-family:'Nunito',sans-serif;
            font-weight:700;font-size:15px;">Cancel</button>
          <button id="stopConfirm" style="flex:2;padding:14px;border-radius:14px;border:none;
            background:linear-gradient(135deg,#f87171,#ef4444 45%,#dc2626);color:#fff;cursor:pointer;
            font-family:'Nunito',sans-serif;font-weight:800;font-size:15px;
            box-shadow:0 8px 24px rgba(239,68,68,0.45);">ğŸ—³ï¸ Yes, Start Voting!</button>
        </div>
      </div>
    `;
    document.body.appendChild(overlay);
    document.getElementById('stopConfirm').onclick = () => { overlay.remove(); resolve(true); };
    document.getElementById('stopCancel').onclick  = () => { overlay.remove(); resolve(false); };
    overlay.onclick = e => { if (e.target === overlay) { overlay.remove(); resolve(false); } };
  });

  if (!confirmed) return;

  // Disable button and update Firebase
  const btn = document.getElementById('stopDiscBtn');
  if (btn) { btn.disabled = true; btn.textContent = 'â³ Starting vote...'; }
  playSound('suspense');
  await storage.update(`rooms/${currentRoom.code}`, { phase: 'voting', votes: {} });
}

// â”€â”€â”€ VOTING RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderVoting(room) {
  document.getElementById('voteRound').textContent = room.round || 1;
  const players = Object.values(room.players || {}).sort((a,b) => a.joinedAt - b.joinedAt);
  const votes = room.votes || {};
  const totalVotes = Object.keys(votes).length;
  const iVotedAlready = votes[myId];

  renderPlayerStrip('votePlayerStrip', players, votes, 'voted');

  // Progress bar
  const pct = players.length > 0 ? (totalVotes / players.length) * 100 : 0;
  document.getElementById('voteProgressBar').style.width = pct + '%';
  document.getElementById('voteStatus').textContent = `${totalVotes} / ${players.length} voted`;

  // Show confirmed message if I already voted
  if (iVotedAlready) {
    document.getElementById('myVoteConfirmed').classList.remove('hidden');
  }

  // Build vote grid
  const grid = document.getElementById('voteGrid');
  grid.innerHTML = '';
  players.forEach((p, i) => {
    const voteCount = Object.values(votes).filter(v => v === p.id).length;
    const btn = document.createElement('button');
    const isSelected = iVotedAlready === p.id;
    const isMe = p.id === myId;
    const avatarDisplay = p.avatar || p.name[0].toUpperCase();
    const isEmoji = p.avatar && p.avatar.length > 0;
    btn.className = 'vote-btn' + (isSelected ? ' selected' : '') + (iVotedAlready && !isSelected ? ' disabled' : '');
    btn.innerHTML = `
      <div style="width:52px;height:52px;border-radius:50%;background:${isEmoji?'rgba(255,255,255,0.08)':getColor(i)};margin:0 auto;display:flex;align-items:center;justify-content:center;font-size:${isEmoji?'28px':'18px'};font-weight:900;border:2px solid ${isEmoji?'rgba(181,108,255,0.2)':getColor(i)};">${avatarDisplay}</div>
      <div class="vote-btn-name">${p.name}${isMe ? ' (You)' : ''}</div>
      <div class="vote-count">${voteCount > 0 ? 'ğŸ”´'.repeat(Math.min(voteCount, 5)) + ` ${voteCount}` : 'â€“'}</div>
    `;
    if (!iVotedAlready && !isMe) {
      btn.onclick = () => castVote(p.id);
    }
    grid.appendChild(btn);
  });

  // Auto resolve when all players voted â€” host triggers result
  if (totalVotes >= players.length && players.length > 0 && room.hostId === myId) {
    setTimeout(() => resolveVotes(room), 800);
  }
}

async function castVote(targetId) {
  if (myVote) return;
  myVote = targetId;
  playSound('vote');
  await storage.update(`rooms/${currentRoom.code}/votes`, { [myId]: targetId });
}

async function resolveVotes(room) {
  const votes = room.votes || {};
  const players = Object.values(room.players || {});
  const impostorIds = room.impostorIds || [];

  // Tally votes
  const tally = {};
  Object.values(votes).forEach(id => { tally[id] = (tally[id] || 0) + 1; });
  const maxV = Math.max(...Object.values(tally));
  const topIds = Object.keys(tally).filter(id => tally[id] === maxV);
  const eliminatedId = topIds[Math.floor(Math.random() * topIds.length)];
  const wasImpostor = impostorIds.includes(eliminatedId);

  // â”€â”€ Calculate scores â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const prevScores = room.scores || {};
  const roundDeltas = {}; // points earned this round per player
  const newScores = {};

  players.forEach(p => {
    const prev = prevScores[p.id] || 0;
    let delta = 0;
    const isImpostor = impostorIds.includes(p.id);
    const myVoteTarget = votes[p.id];
    const iVotedCorrectly = myVoteTarget && impostorIds.includes(myVoteTarget);

    if (isImpostor && !wasImpostor) {
      delta = 4; // impostor survived
    } else if (!isImpostor && wasImpostor && iVotedCorrectly) {
      delta = 3; // citizen found impostor
    }
    roundDeltas[p.id] = delta;
    newScores[p.id] = prev + delta;
  });

  await storage.update(`rooms/${room.code}`, {
    phase: 'leaderboard',
    eliminated: eliminatedId,
    finalTally: tally,
    scores: newScores,
    roundDeltas,
  });
}

// â”€â”€â”€ RESULTS RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderResults(room) {
  myVote = null;

  const eliminatedId = room.eliminated;
  const impostorIds = room.impostorIds || [];
  const wasImpostor = impostorIds.includes(eliminatedId);
  const players = Object.values(room.players || {}).sort((a,b) => a.joinedAt - b.joinedAt);
  const votes = room.votes || {};
  const finalTally = room.finalTally || {};

  const amImpostor = impostorIds.includes(myId);
  const myVoteTarget = votes[myId];
  const iVotedCorrectly = myVoteTarget && impostorIds.includes(myVoteTarget);

  // â”€â”€ Personal outcome â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let emoji, title, sub, bannerBg, bannerBorder;

  if (amImpostor) {
    if (!wasImpostor) {
      // impostor escaped
      emoji = 'ğŸ˜ˆ'; title = 'YOU ESCAPED!';
      sub = 'You fooled everyone and survived!\nYou are the master deceiver.';
      bannerBg = 'linear-gradient(160deg,rgba(239,68,68,0.25),rgba(139,0,0,0.15))';
      bannerBorder = 'rgba(239,68,68,0.4)';
    } else {
      // impostor caught
      emoji = 'ğŸ˜…'; title = 'YOU GOT CAUGHT!';
      sub = 'They figured you out.\nBetter luck next round, impostor!';
      bannerBg = 'linear-gradient(160deg,rgba(239,68,68,0.15),rgba(0,0,0,0.1))';
      bannerBorder = 'rgba(239,68,68,0.3)';
    }
  } else {
    if (wasImpostor && iVotedCorrectly) {
      // citizen voted correctly, impostor caught
      emoji = 'ğŸ‰'; title = 'GREAT DETECTIVE!';
      sub = 'You found the impostor!\nYour vote made the difference. ğŸ”';
      bannerBg = 'linear-gradient(160deg,rgba(34,197,94,0.25),rgba(16,163,74,0.15))';
      bannerBorder = 'rgba(34,197,94,0.5)';
    } else if (wasImpostor && !iVotedCorrectly) {
      // impostor caught but this person voted wrong
      emoji = 'ğŸ˜¬'; title = 'LUCKY WIN!';
      sub = 'The impostor was caught â€” but you voted wrong!\nPay closer attention next time.';
      bannerBg = 'linear-gradient(160deg,rgba(245,158,11,0.2),rgba(180,100,0,0.1))';
      bannerBorder = 'rgba(245,158,11,0.4)';
    } else {
      // impostor won
      emoji = 'ğŸ’€'; title = 'IMPOSTOR WINS!';
      sub = 'You got tricked.\nThe impostor slipped right past you!';
      bannerBg = 'linear-gradient(160deg,rgba(239,68,68,0.15),rgba(0,0,0,0.2))';
      bannerBorder = 'rgba(239,68,68,0.3)';
    }
  }

  const banner = document.getElementById('personalOutcomeBanner');
  banner.style.background = bannerBg;
  banner.style.borderBottom = `1px solid ${bannerBorder}`;
  document.getElementById('resultHeroEmoji').textContent = emoji;
  document.getElementById('resultHeroTitle').textContent = title;
  document.getElementById('resultHeroTitle').style.color = (wasImpostor && iVotedCorrectly && !amImpostor) ? 'var(--green)' : (amImpostor && !wasImpostor) ? 'var(--red)' : 'var(--yellow)';
  document.getElementById('resultHeroSub').textContent = sub;

  // â”€â”€ Correct voters card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const correctVoters = players.filter(p => votes[p.id] && impostorIds.includes(votes[p.id]));
  const correctCard = document.getElementById('correctVotersCard');
  const correctList = document.getElementById('correctVotersList');
  correctList.innerHTML = '';

  if (wasImpostor && correctVoters.length > 0) {
    correctCard.style.display = 'block';
    correctCard.style.background = 'rgba(34,197,94,0.08)';
    correctCard.style.border = '1px solid rgba(34,197,94,0.25)';
    correctVoters.forEach((p, idx) => {
      const isMe = p.id === myId;
      const div = document.createElement('div');
      div.style.cssText = `display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:12px;background:${isMe?'rgba(34,197,94,0.15)':'rgba(255,255,255,0.04)'};border:1px solid ${isMe?'rgba(34,197,94,0.4)':'rgba(255,255,255,0.08)'};`;
      const pi = players.indexOf(p);
      div.innerHTML = `
        <div style="width:36px;height:36px;border-radius:50%;background:${getColor(pi)};display:flex;align-items:center;justify-content:center;font-weight:900;font-size:15px;flex-shrink:0;">${p.name[0]}</div>
        <div>
          <div style="font-weight:800;font-size:14px;color:#fff;">${p.name}${isMe?' <span style="color:var(--green);font-size:12px;">(You)</span>':''}</div>
          <div style="font-size:11px;color:var(--green);margin-top:2px;">âœ… Voted correctly</div>
        </div>
        ${isMe?'<span style="margin-left:auto;font-size:24px;">ğŸ†</span>':'<span style="margin-left:auto;font-size:20px;">ğŸ¯</span>'}
      `;
      correctList.appendChild(div);
    });
  }

  // â”€â”€ Words reveal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('revealCitizenWord').textContent = room.citizenWord;
  document.getElementById('revealImpostorWord').textContent = room.impostorWord;

  // â”€â”€ All players with roles & who they voted for â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const allReveal = document.getElementById('allPlayersReveal');
  allReveal.innerHTML = '';
  players.forEach((p, i) => {
    const isImp = impostorIds.includes(p.id);
    const isElim = p.id === eliminatedId;
    const votedFor = votes[p.id];
    const votedForPlayer = players.find(pl => pl.id === votedFor);
    const votedCorrectly = votedFor && impostorIds.includes(votedFor);
    const isMe = p.id === myId;

    const div = document.createElement('div');
    div.style.cssText = `display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:12px;background:${isMe?'rgba(168,85,247,0.08)':'rgba(255,255,255,0.04)'};border:1px solid ${isElim?'rgba(239,68,68,0.3)':isMe?'rgba(168,85,247,0.3)':'rgba(255,255,255,0.07)'};`;
    div.innerHTML = `
      <div style="width:34px;height:34px;border-radius:50%;background:${getColor(i)};display:flex;align-items:center;justify-content:center;font-weight:900;font-size:13px;flex-shrink:0;">${p.name[0]}</div>
      <div style="flex:1;min-width:0;">
        <div style="font-weight:800;font-size:14px;display:flex;align-items:center;gap:6px;">
          ${p.name}${isMe?' <span style="color:var(--muted);font-size:11px;">(You)</span>':''}
          ${isImp?'<span style="background:rgba(239,68,68,0.2);color:var(--red);font-size:10px;padding:2px 8px;border-radius:10px;font-weight:700;letter-spacing:0.5px;">IMPOSTOR</span>':''}
        </div>
        <div style="font-size:11px;color:var(--muted);margin-top:2px;">
          Voted: <span style="color:${votedCorrectly?'var(--green)':'rgba(255,255,255,0.5)'};">${votedForPlayer?votedForPlayer.name:'â€”'}${votedCorrectly?' âœ…':''}</span>
        </div>
      </div>
      <span style="font-size:18px;flex-shrink:0;">${isElim?'ğŸ’€':isImp?'ğŸ•µï¸':'ğŸ‘¤'}</span>
    `;
    allReveal.appendChild(div);
  });

  // â”€â”€ Confetti and sounds â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if ((wasImpostor && iVotedCorrectly && !amImpostor) || (amImpostor && !wasImpostor)) {
    spawnConfetti();
    setTimeout(() => playSound('win'), 300);
  } else {
    setTimeout(() => playSound('lose'), 300);
  }

  // â”€â”€ Play again button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (room.hostId !== myId) {
    document.getElementById('playAgainBtn').textContent = 'â³ Waiting for host...';
    document.getElementById('playAgainBtn').disabled = true;
  } else {
    document.getElementById('playAgainBtn').disabled = false;
    document.getElementById('playAgainBtn').textContent = 'ğŸ”„ Play Again';
  }
}

function spawnConfetti() {
  const container = document.getElementById('confettiContainer');
  container.innerHTML = '';
  const colors = ['#a855f7','#3b82f6','#22c55e','#f59e0b','#ec4899','#ef4444','#fff'];
  for (let i = 0; i < 60; i++) {
    const el = document.createElement('div');
    const size = 8 + Math.random() * 8;
    el.style.cssText = `
      position:absolute;width:${size}px;height:${size}px;border-radius:${Math.random()>0.5?'50%':'3px'};
      background:${rand(colors)};left:${Math.random()*100}%;top:-20px;
      animation:confettiFall ${2+Math.random()*3}s linear ${Math.random()*2}s forwards;
    `;
    container.appendChild(el);
  }
}

function goToResults() {
  if (currentRoom) { renderResults(currentRoom); goTo('results'); }
}

function renderLeaderboard(room) {
  document.getElementById('lbRound').textContent = room.round || 1;

  const players = Object.values(room.players || {}).sort((a,b) => a.joinedAt - b.joinedAt);
  const scores = room.scores || {};
  const deltas = room.roundDeltas || {};

  // Sort by score descending
  const ranked = [...players].sort((a,b) => (scores[b.id]||0) - (scores[a.id]||0));

  const list = document.getElementById('leaderboardList');
  list.innerHTML = '';

  const medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
  const rowClasses = ['first','second','third'];

  ranked.forEach((p, i) => {
    const score = scores[p.id] || 0;
    const delta = deltas[p.id] || 0;
    const isMe = p.id === myId;
    const rank = i + 1;
    const avatarDisplay = p.avatar || p.name[0].toUpperCase();
    const isEmoji = p.avatar && p.avatar.length > 0;
    const playerIdx = players.indexOf(p);

    const row = document.createElement('div');
    row.className = `lb-row${isMe ? ' me' : ''}${i < 3 ? ' ' + rowClasses[i] : ''}`;

    row.innerHTML = `
      <div class="lb-rank" style="color:${i===0?'var(--yellow)':i===1?'#94a3b8':i===2?'#b47c3c':'rgba(255,255,255,0.4)'};">
        ${i < 3 ? medals[i] : rank}
      </div>
      <div style="width:38px;height:38px;border-radius:50%;background:${isEmoji?'rgba(255,255,255,0.08)':getColor(playerIdx)};display:flex;align-items:center;justify-content:center;font-size:${isEmoji?'22px':'14px'};font-weight:900;flex-shrink:0;">
        ${avatarDisplay}
      </div>
      <div style="flex:1;min-width:0;">
        <div style="font-weight:800;font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
          ${p.name}${isMe?' <span style="color:var(--purple);font-size:12px;">(You)</span>':''}
        </div>
        <div style="font-size:12px;color:var(--muted);margin-top:2px;">
          ${delta > 0 ? `<span style="color:var(--green);">+${delta} this round</span>` : '<span style="color:rgba(255,255,255,0.2);">+0 this round</span>'}
        </div>
      </div>
      <div class="lb-score" style="color:${i===0?'var(--yellow)':i===1?'#94a3b8':i===2?'#b47c3c':'#fff'};">
        ${score}
      </div>
    `;

    // Show floating +points if earned
    if (delta > 0) {
      const badge = document.createElement('div');
      badge.className = 'score-delta';
      badge.textContent = '+' + delta;
      badge.style.color = delta >= 4 ? 'var(--red)' : 'var(--green)';
      row.appendChild(badge);
    }

    list.appendChild(row);
  });

  // Show host/guest controls
  if (room.hostId === myId) {
    document.getElementById('lbHostControls').classList.remove('hidden');
    document.getElementById('lbGuestWait').classList.add('hidden');
  } else {
    document.getElementById('lbHostControls').classList.add('hidden');
    document.getElementById('lbGuestWait').classList.remove('hidden');
  }
}

async function playAgain() {
  if (!currentRoom || currentRoom.hostId !== myId) return;
  const players = Object.values(currentRoom.players||{});
  const reset = {};
  // Preserve scores and avatars across rounds!
  players.forEach(p => { reset[p.id] = {...p, ready:false, vote:null}; });
  await storage.update(`rooms/${currentRoom.code}`, {
    phase: 'lobby', citizenWord:'', impostorWord:'',
    impostorIds:[], votes:{}, eliminated:null, players:reset,
    kicked:{}, roundDeltas:{},
    // scores persist â€” NOT reset here
  });
  myVote = null;
}

async function leaveRoom() {
  if (currentRoom) {
    await storage.remove(`rooms/${currentRoom.code}/players/${myId}`);
    if (unsubscribe) { unsubscribe(); unsubscribe = null; }
    currentRoom = null;
  }
  goHome();
}

function goHome() {
  myVote = null;
  if (unsubscribe) { unsubscribe(); unsubscribe = null; }
  currentRoom = null; isHost = false;
  goTo('home');
}

// â”€â”€â”€ BACKGROUND CANVAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function() {
  const canvas = document.getElementById('bgCanvas');
  const ctx = canvas.getContext('2d');
  let W, H, frame;

  function resize() {
    W = canvas.width = window.innerWidth;
    H = canvas.height = window.innerHeight;
  }
  resize();
  window.addEventListener('resize', resize);

  // â”€â”€ Gradient mesh blobs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const blobs = [
    { x: 0.15, y: 0.2,  r: 0.45, color: '#a855f7', speed: 0.00018, phase: 0 },
    { x: 0.85, y: 0.75, r: 0.38, color: '#3b82f6', speed: 0.00022, phase: 2.1 },
    { x: 0.5,  y: 0.5,  r: 0.30, color: '#ec4899', speed: 0.00015, phase: 4.3 },
    { x: 0.2,  y: 0.8,  r: 0.25, color: '#06b6d4', speed: 0.00020, phase: 1.5 },
    { x: 0.8,  y: 0.2,  r: 0.28, color: '#8b5cf6', speed: 0.00017, phase: 3.7 },
  ];

  // â”€â”€ Floating particles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const particles = Array.from({ length: 55 }, () => ({
    x: Math.random() * 1,
    y: Math.random() * 1,
    vx: (Math.random() - 0.5) * 0.0003,
    vy: (Math.random() - 0.5) * 0.0003,
    r: Math.random() * 1.5 + 0.4,
    alpha: Math.random() * 0.5 + 0.15,
    color: ['#a855f7','#3b82f6','#ec4899','#22c55e','#f59e0b','#fff'][Math.floor(Math.random()*6)],
    pulse: Math.random() * Math.PI * 2,
    pulseSpeed: 0.005 + Math.random() * 0.01,
  }));

  // â”€â”€ Spy silhouettes drifting across â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const SPIES = ['ğŸ•µï¸','ğŸ‘¤','ğŸ­','ğŸ‘ï¸','ğŸ”'];
  const floaters = Array.from({ length: 8 }, (_, i) => ({
    x: Math.random(),
    y: Math.random(),
    size: 18 + Math.random() * 24,
    vx: (0.00008 + Math.random() * 0.00012) * (Math.random() > 0.5 ? 1 : -1),
    vy: (0.00004 + Math.random() * 0.00008) * (Math.random() > 0.5 ? 1 : -1),
    emoji: SPIES[i % SPIES.length],
    alpha: 0.06 + Math.random() * 0.08,
    rotation: Math.random() * Math.PI * 2,
    rotSpeed: (Math.random() - 0.5) * 0.002,
  }));

  // â”€â”€ Grid lines â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let gridOffset = 0;

  // â”€â”€ Connection lines between close particles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const MAX_DIST = 0.18;

  let t = 0;

  function draw() {
    t++;
    ctx.clearRect(0, 0, W, H);

    // Deep base gradient
    const base = ctx.createLinearGradient(0, 0, W, H);
    base.addColorStop(0,   '#05060e');
    base.addColorStop(0.5, '#080918');
    base.addColorStop(1,   '#060810');
    ctx.fillStyle = base;
    ctx.fillRect(0, 0, W, H);

    // â”€â”€ Animated mesh blobs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    blobs.forEach(b => {
      const bx = (b.x + Math.sin(t * b.speed + b.phase) * 0.12) * W;
      const by = (b.y + Math.cos(t * b.speed * 0.7 + b.phase) * 0.1) * H;
      const br = b.r * Math.min(W, H);
      const grad = ctx.createRadialGradient(bx, by, 0, bx, by, br);
      grad.addColorStop(0,   hexAlpha(b.color, 0.18));
      grad.addColorStop(0.5, hexAlpha(b.color, 0.07));
      grad.addColorStop(1,   'transparent');
      ctx.fillStyle = grad;
      ctx.beginPath();
      ctx.arc(bx, by, br, 0, Math.PI * 2);
      ctx.fill();
    });

    // â”€â”€ Moving grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    gridOffset = (gridOffset + 0.15) % 60;
    ctx.strokeStyle = 'rgba(168,85,247,0.04)';
    ctx.lineWidth = 0.5;
    for (let x = -60 + (gridOffset % 60); x < W + 60; x += 60) {
      ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, H); ctx.stroke();
    }
    for (let y = -60 + (gridOffset % 60); y < H + 60; y += 60) {
      ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke();
    }

    // â”€â”€ Particles + connections â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    particles.forEach(p => {
      p.x += p.vx; p.y += p.vy;
      p.pulse += p.pulseSpeed;
      if (p.x < 0) p.x = 1; if (p.x > 1) p.x = 0;
      if (p.y < 0) p.y = 1; if (p.y > 1) p.y = 0;

      const px = p.x * W, py = p.y * H;
      const pulsedAlpha = p.alpha * (0.7 + 0.3 * Math.sin(p.pulse));
      const pulsedR = p.r * (1 + 0.3 * Math.sin(p.pulse * 0.7));

      // Glow
      const glow = ctx.createRadialGradient(px, py, 0, px, py, pulsedR * 5);
      glow.addColorStop(0, hexAlpha(p.color, pulsedAlpha * 0.8));
      glow.addColorStop(1, 'transparent');
      ctx.fillStyle = glow;
      ctx.beginPath();
      ctx.arc(px, py, pulsedR * 5, 0, Math.PI * 2);
      ctx.fill();

      // Core dot
      ctx.beginPath();
      ctx.arc(px, py, pulsedR, 0, Math.PI * 2);
      ctx.fillStyle = hexAlpha(p.color, pulsedAlpha);
      ctx.fill();
    });

    // Connection lines
    for (let i = 0; i < particles.length; i++) {
      for (let j = i + 1; j < particles.length; j++) {
        const dx = particles[i].x - particles[j].x;
        const dy = particles[i].y - particles[j].y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        if (dist < MAX_DIST) {
          const alpha = (1 - dist / MAX_DIST) * 0.12;
          ctx.strokeStyle = `rgba(168,85,247,${alpha})`;
          ctx.lineWidth = 0.6;
          ctx.beginPath();
          ctx.moveTo(particles[i].x * W, particles[i].y * H);
          ctx.lineTo(particles[j].x * W, particles[j].y * H);
          ctx.stroke();
        }
      }
    }

    // â”€â”€ Floating emoji silhouettes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    floaters.forEach(f => {
      f.x += f.vx; f.y += f.vy;
      f.rotation += f.rotSpeed;
      if (f.x < -0.1) f.x = 1.1;
      if (f.x > 1.1)  f.x = -0.1;
      if (f.y < -0.1) f.y = 1.1;
      if (f.y > 1.1)  f.y = -0.1;

      ctx.save();
      ctx.globalAlpha = f.alpha;
      ctx.translate(f.x * W, f.y * H);
      ctx.rotate(f.rotation);
      ctx.font = `${f.size}px serif`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(f.emoji, 0, 0);
      ctx.restore();
    });

    // â”€â”€ Vignette â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const vig = ctx.createRadialGradient(W/2, H/2, H*0.2, W/2, H/2, H*0.85);
    vig.addColorStop(0, 'transparent');
    vig.addColorStop(1, 'rgba(0,0,0,0.55)');
    ctx.fillStyle = vig;
    ctx.fillRect(0, 0, W, H);

    frame = requestAnimationFrame(draw);
  }

  function hexAlpha(hex, alpha) {
    const h = hex.replace('#','');
    const r = parseInt(h.substring(0,2), 16);
    const g = parseInt(h.substring(2,4), 16);
    const b = parseInt(h.substring(4,6), 16);
    if (isNaN(r) || isNaN(g) || isNaN(b)) return `rgba(168,85,247,${clamp(alpha)})`;
    return `rgba(${r},${g},${b},${clamp(alpha)})`;
  }

  function clamp(v) {
    const n = Number(v);
    if (isNaN(n)) return 0;
    return Math.min(1, Math.max(0, n));
  }

  draw();
})();

// â”€â”€â”€ AVATAR PICKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAvatarGrid(containerId) {
  const grid = document.getElementById(containerId);
  if (!grid) return;
  grid.innerHTML = '';
  AVATARS.forEach(av => {
    const btn = document.createElement('button');
    btn.className = 'avatar-opt' + (av === myAvatar ? ' selected' : '');
    btn.textContent = av;
    btn.onclick = () => {
      myAvatar = av;
      grid.querySelectorAll('.avatar-opt').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      // sync to other grid too
      ['createAvatarGrid','joinAvatarGrid'].forEach(id => {
        const g = document.getElementById(id);
        if (g && g !== grid) {
          g.querySelectorAll('.avatar-opt').forEach(b => {
            b.classList.toggle('selected', b.textContent === av);
          });
        }
      });
      playSound('click');
    };
    grid.appendChild(btn);
  });
}

// â”€â”€â”€ SOUND ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let audioCtx = null;

function getAudioCtx() {
  if (!audioCtx) audioCtx = new AudioCtx();
  return audioCtx;
}

function playSound(type) {
  if (!soundEnabled) return;
  try {
    const ctx = getAudioCtx();
    const g = ctx.createGain();
    g.connect(ctx.destination);

    if (type === 'click') {
      const o = ctx.createOscillator();
      o.connect(g); g.gain.setValueAtTime(0.15, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.1);
      o.frequency.setValueAtTime(600, ctx.currentTime);
      o.start(); o.stop(ctx.currentTime + 0.1);

    } else if (type === 'vote') {
      [440,550,660].forEach((f,i) => {
        const o = ctx.createOscillator();
        o.connect(g); g.gain.setValueAtTime(0.2, ctx.currentTime + i*0.1);
        g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + i*0.1 + 0.15);
        o.frequency.setValueAtTime(f, ctx.currentTime + i*0.1);
        o.start(ctx.currentTime + i*0.1);
        o.stop(ctx.currentTime + i*0.1 + 0.15);
      });

    } else if (type === 'win') {
      [523,659,784,1047].forEach((f,i) => {
        const o = ctx.createOscillator();
        o.type = 'sine';
        o.connect(g); g.gain.setValueAtTime(0.25, ctx.currentTime + i*0.12);
        g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + i*0.12 + 0.3);
        o.frequency.setValueAtTime(f, ctx.currentTime + i*0.12);
        o.start(ctx.currentTime + i*0.12);
        o.stop(ctx.currentTime + i*0.12 + 0.3);
      });

    } else if (type === 'lose') {
      [400,350,280].forEach((f,i) => {
        const o = ctx.createOscillator();
        o.type = 'sawtooth';
        o.connect(g); g.gain.setValueAtTime(0.15, ctx.currentTime + i*0.15);
        g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + i*0.15 + 0.2);
        o.frequency.setValueAtTime(f, ctx.currentTime + i*0.15);
        o.start(ctx.currentTime + i*0.15);
        o.stop(ctx.currentTime + i*0.15 + 0.2);
      });

    } else if (type === 'suspense') {
      // Low pulsing suspense during voting
      const o = ctx.createOscillator();
      const lfo = ctx.createOscillator();
      const lfoGain = ctx.createGain();
      lfo.frequency.value = 3;
      lfoGain.gain.value = 20;
      lfo.connect(lfoGain); lfoGain.connect(o.frequency);
      o.type = 'sine'; o.frequency.value = 120;
      o.connect(g); g.gain.setValueAtTime(0.18, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 1.5);
      lfo.start(); lfo.stop(ctx.currentTime + 1.5);
      o.start(); o.stop(ctx.currentTime + 1.5);

    } else if (type === 'reveal') {
      // Dramatic whoosh
      const o = ctx.createOscillator();
      o.type = 'sine'; o.connect(g);
      g.gain.setValueAtTime(0.001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.3, ctx.currentTime + 0.3);
      g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.8);
      o.frequency.setValueAtTime(200, ctx.currentTime);
      o.frequency.exponentialRampToValueAtTime(800, ctx.currentTime + 0.4);
      o.start(); o.stop(ctx.currentTime + 0.8);

    } else if (type === 'reaction') {
      const o = ctx.createOscillator();
      o.type = 'sine'; o.connect(g);
      g.gain.setValueAtTime(0.12, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.2);
      o.frequency.setValueAtTime(880, ctx.currentTime);
      o.start(); o.stop(ctx.currentTime + 0.2);

    } else if (type === 'countdown') {
      const o = ctx.createOscillator();
      o.type = 'sine'; o.connect(g);
      g.gain.setValueAtTime(0.2, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.15);
      o.frequency.setValueAtTime(type === 'go' ? 1200 : 440, ctx.currentTime);
      o.start(); o.stop(ctx.currentTime + 0.15);
    }
  } catch(e) {}
}

function toggleSound() {
  soundEnabled = !soundEnabled;
  document.getElementById('soundToggle').textContent = soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
  if (soundEnabled) playSound('click');
}

// â”€â”€â”€ CARD FLIP REVEAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startRevealCountdown() {
  const overlay = document.getElementById('countdownOverlay');
  const scene   = document.getElementById('cardFlipScene');
  const numEl   = document.getElementById('countdownNum');

  // Show countdown, hide card
  overlay.style.display = 'block';
  scene.style.display   = 'none';

  let count = 3;
  function tick() {
    numEl.textContent = count;
    numEl.style.animation = 'none';
    numEl.offsetHeight; // reflow
    numEl.style.animation = 'countPop 0.4s cubic-bezier(0.34,1.56,0.64,1)';
    playSound('countdown');

    if (count > 1) {
      count--;
      setTimeout(tick, 900);
    } else {
      // Done â€” hide countdown, show card with pop animation
      setTimeout(() => {
        overlay.style.display = 'none';
        scene.style.display   = 'block';
        scene.style.animation = 'none';
        scene.offsetHeight;
        scene.style.animation = 'slideUp 0.4s ease';
        playSound('reveal');
      }, 800);
    }
  }
  tick();
}

// â”€â”€â”€ EMOJI REACTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sendReaction(emoji) {
  if (!currentRoom) return;
  playSound('reaction');
  // Show locally immediately
  spawnFloatingReaction(emoji);
  // Sync to Firebase
  if (firebaseConnected && db) {
    const ref = db.ref(`rooms/${currentRoom.code}/reactions`);
    ref.push({ emoji, from: myId, name: myName, t: Date.now() });
  }
}

function spawnFloatingReaction(emoji) {
  const el = document.createElement('div');
  el.className = 'floating-reaction';
  el.textContent = emoji;
  const x = 20 + Math.random() * 60;
  el.style.left = x + 'vw';
  el.style.bottom = '120px';
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 1500);
}

function listenReactions(roomCode) {
  if (!firebaseConnected || !db) return;
  const ref = db.ref(`rooms/${roomCode}/reactions`);
  // Only listen to new ones
  ref.limitToLast(1).on('child_added', snap => {
    const data = snap.val();
    if (data && data.from !== myId) {
      spawnFloatingReaction(data.emoji);
      playSound('reaction');
    }
  });
}

// â”€â”€â”€ ANONYMOUS ACCUSATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendAccusation() {
  if (accusationSent) return;
  const input = document.getElementById('accusationInput');
  const msg = input.value.trim();
  if (!msg) return;

  accusationSent = true;
  input.value = '';
  document.getElementById('accusationInputArea').classList.add('hidden');
  document.getElementById('accusationUsed').classList.remove('hidden');

  const accusation = { msg, t: Date.now() };
  if (firebaseConnected && db && currentRoom) {
    await db.ref(`rooms/${currentRoom.code}/accusations`).push(accusation);
  } else {
    // demo mode â€” show locally
    renderAccusation(accusation);
  }
  playSound('click');
}

function renderAccusation(data) {
  const feed = document.getElementById('accusationFeed');
  if (!feed) return;
  const div = document.createElement('div');
  div.className = 'accusation-msg';
  div.textContent = `ğŸ•µï¸ Anonymous: "${data.msg}"`;
  feed.appendChild(div);
  feed.scrollTop = feed.scrollHeight;
}

function listenAccusations(roomCode) {
  if (!firebaseConnected || !db) return;
  const ref = db.ref(`rooms/${roomCode}/accusations`);
  ref.on('child_added', snap => {
    const data = snap.val();
    if (data) renderAccusation(data);
  });
}

// â”€â”€â”€ RIPPLE EFFECT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('pointerdown', function(e) {
  const btn = e.target.closest('.btn');
  if (!btn || btn.disabled) return;
  const rect = btn.getBoundingClientRect();
  const ripple = document.createElement('span');
  ripple.className = 'ripple';
  ripple.style.top  = (e.clientY - rect.top)  + 'px';
  ripple.style.left = (e.clientX - rect.left) + 'px';
  btn.appendChild(ripple);
  ripple.addEventListener('animationend', () => ripple.remove());
});

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
renderCategoryChips();
updateCategoryInfo();
renderAvatarGrid('createAvatarGrid');
renderAvatarGrid('joinAvatarGrid');

// â”€â”€ Firebase auto-init (runs after SDKs are loaded) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function initFirebase() {
  try {
    // âœ… Hardcoded config â€” connects automatically every time, no setup needed!
    const HARDCODED = {
      apiKey: "AIzaSyB3VfquYUOXpYNwONDrJeD0eoNrwKpR8rw",
      authDomain: "imposter-game-a8ef3.firebaseapp.com",
      databaseURL: "https://imposter-game-a8ef3-default-rtdb.firebaseio.com",
      projectId: "imposter-game-a8ef3",
      storageBucket: "imposter-game-a8ef3.firebasestorage.app",
      messagingSenderId: "866014157331",
      appId: "1:866014157331:web:27d84c398cd4568bd03de6",
      measurementId: "G-SG9LG3SDTZ"
    };

    // Also check localStorage in case user set a different config via Setup button
    const saved = localStorage.getItem('impostor_firebase_config');
    const firebaseConfig = saved ? JSON.parse(saved) : HARDCODED;

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    db = firebase.database();
    firebaseConnected = true;
    showConnectedStatus();
    console.log('âœ… Firebase connected!');
  } catch(e) {
    firebaseConnected = false;
    console.warn('âš ï¸ Firebase init failed:', e.message);
  }
})();
</script>

<!-- Footer -->
<div style="position:fixed;bottom:0;left:0;right:0;text-align:center;padding:8px 16px calc(8px + env(safe-area-inset-bottom));font-family:'Nunito',sans-serif;font-size:12px;color:rgba(255,255,255,0.2);letter-spacing:0.5px;z-index:10;pointer-events:none;background:linear-gradient(to top, rgba(5,6,14,0.8), transparent);">
  Developed by <span style="color:rgba(168,85,247,0.6);font-weight:700;">Prasid R Shetty</span>
</div>

</body>
</html>
